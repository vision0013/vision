import { AIAnalysisResult } from '../types/ai-types';

/**
 * AI ì‘ë‹µ íŒŒì‹± ë° í´ë°± ì²˜ë¦¬
 */
export class AIResponseParser {
  /**
   * AI ì‘ë‹µì„ íŒŒì‹±í•˜ì—¬ AIAnalysisResultë¡œ ë³€í™˜
   */
  static parseAIResponse(response: string, _originalCommand: string): AIAnalysisResult {
    try {
      console.log('ğŸ” [ai-response-parser] Raw AI response:', response);

      const firstBrace = response.indexOf('{');
      const lastBrace = response.lastIndexOf('}');

      if (firstBrace === -1 || lastBrace === -1 || lastBrace < firstBrace) {
        console.warn('âš ï¸ [ai-response-parser] No valid JSON object found in response.');
        return { plan: [], reasoning: 'Fallback: No JSON object found in AI response.', rawResponse: response };
      }

      let jsonString = response.substring(firstBrace, lastBrace + 1);
      // ê¸°ë³¸ì ì¸ JSON ì •ë¦¬
      jsonString = jsonString.replace(/\n/g, '\n').replace(/'/g, "'").replace(/"/g, '"').replace(/&/g, "&").replace(/\r/g, "\r\t").replace(/\t/g, "\t").replace(/\b/g, "\b").replace(/\f/g, "\f");
      jsonString = jsonString.replace(/[\u0000-\u0019]+/g,"");

      console.log('ğŸ”§ [ai-response-parser] Sanitized JSON string:', jsonString);
      
      const parsedResponse = JSON.parse(jsonString);

      if (parsedResponse.plan && Array.isArray(parsedResponse.plan)) {
        return {
          plan: parsedResponse.plan,
          reasoning: parsedResponse.reasoning || 'Plan generated by AI.',
          rawResponse: response,
        };
      } else {
        console.warn('âš ï¸ [ai-parser] Parsed JSON does not contain a valid "plan" array.');
        return { plan: [], reasoning: 'Fallback: Parsed JSON has no valid plan.', rawResponse: response };
      }
    } catch (error: any) {
      console.error('âŒ [ai-parser] Failed to parse AI response JSON:', error);
      console.error('âŒ [ai-parser] Original response was:', response);

      return { plan: [], reasoning: `Fallback: JSON parsing failed: ${error.message}`, rawResponse: response };
    }
  }
}