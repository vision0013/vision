import { AIAnalysisResult } from '../types/ai-types';

/**
 * AI ì‘ë‹µ íŒŒì‹± ë° í´ë°± ì²˜ë¦¬
 */
export class AIResponseParser {
  /**
   * ì±„íŒ… ëª¨ë“œìš© AI ì‘ë‹µ íŒŒì‹± (í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ë°˜í™˜)
   */
  static parseChatResponse(response: string): string {
    try {
      console.log('ğŸ’¬ [ai-response-parser] Chat response:', response);

      // ì±„íŒ… ëª¨ë“œì—ì„œëŠ” í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ë°˜í™˜
      const cleanResponse = response.trim();
      return cleanResponse || 'ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    } catch (error: any) {
      console.error('âŒ [ai-parser] Failed to process chat response:', error);
      return 'ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    }
  }

  /**
   * AI ì‘ë‹µì„ íŒŒì‹±í•˜ì—¬ AIAnalysisResultë¡œ ë³€í™˜
   */
  static parseAIResponse(response: string, _originalCommand: string, mode?: string): AIAnalysisResult {
    try {
      console.log('ğŸ” [ai-response-parser] Raw AI response:', response);
      console.log('ğŸ” [ai-response-parser] Mode:', mode);

      // ì±„íŒ… ëª¨ë“œì—ì„œëŠ” í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ë°˜í™˜
      if (mode === 'chat') {
        const cleanResponse = response.trim();
        return {
          plan: [],
          reasoning: cleanResponse,
          rawResponse: cleanResponse
        };
      }

      const firstBrace = response.indexOf('{');
      const lastBrace = response.lastIndexOf('}');

      if (firstBrace === -1 || lastBrace === -1 || lastBrace < firstBrace) {
        console.warn('âš ï¸ [ai-response-parser] No valid JSON object found in response.');
        return { plan: [], reasoning: 'Fallback: No JSON object found in AI response.', rawResponse: response };
      }

      let jsonString = response.substring(firstBrace, lastBrace + 1);
      // ê¸°ë³¸ì ì¸ JSON ì •ë¦¬
      jsonString = jsonString.replace(/\n/g, '\n').replace(/'/g, "'").replace(/"/g, '"').replace(/&/g, "&").replace(/\r/g, "\r\t").replace(/\t/g, "\t").replace(/\b/g, "\b").replace(/\f/g, "\f");
      jsonString = jsonString.replace(/[\u0000-\u0019]+/g,"");

      console.log('ğŸ”§ [ai-response-parser] Sanitized JSON string:', jsonString);
      
      const parsedResponse = JSON.parse(jsonString);

      if (parsedResponse.plan && Array.isArray(parsedResponse.plan)) {
        return {
          plan: parsedResponse.plan,
          reasoning: parsedResponse.reasoning || 'Plan generated by AI.',
          rawResponse: response,
        };
      } else {
        console.warn('âš ï¸ [ai-parser] Parsed JSON does not contain a valid "plan" array.');
        return { plan: [], reasoning: 'Fallback: Parsed JSON has no valid plan.', rawResponse: response };
      }
    } catch (error: any) {
      console.error('âŒ [ai-parser] Failed to parse AI response JSON:', error);
      console.error('âŒ [ai-parser] Original response was:', response);

      return { plan: [], reasoning: `Fallback: JSON parsing failed: ${error.message}`, rawResponse: response };
    }
  }
}