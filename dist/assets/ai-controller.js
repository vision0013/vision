var Dr=Object.defineProperty;var jr=(e,t,n)=>t in e?Dr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var k=(e,t,n)=>jr(e,typeof t!="symbol"?t+"":t,n);const ce={"gemma3-4b-it":{id:"gemma3-4b-it",name:"Gemma 3 4B IT",description:"4B 파라미터 고성능 모델 (현재 사용 중)",modelPath:"https://huggingface.co/litert-community/Gemma3-4B-IT/resolve/main/gemma3-4b-it-int4-web.task",size:"2.4GB",requiresToken:!0,quantization:"int4",category:"medium",defaultConfig:{maxTokens:8192,temperature:.05,topK:40,randomSeed:42},performance:{avgResponseTime:347,memoryUsage:"2.4GB"}},"gemma3-12b-it":{id:"gemma3-12b-it",name:"Gemma 3 12B IT",description:"12B 파라미터 고성능 대형 모델 (8GB+ VRAM 필요)",modelPath:"https://huggingface.co/litert-community/Gemma3-12B-IT/resolve/main/gemma3-12b-it-int4-web.task",size:"7.55GB",requiresToken:!0,quantization:"int4",category:"large",defaultConfig:{maxTokens:8192,temperature:.05,topK:40,randomSeed:42},performance:{avgResponseTime:500,memoryUsage:"7.55GB"}}},et="gemma3-4b-it";var ye=typeof self<"u"?self:{};function $n(e){e:{for(var t=["CLOSURE_FLAGS"],n=ye,r=0;r<t.length;r++)if((n=n[t[r]])==null){t=null;break e}t=n}return(e=t&&t[e])!=null&&e}let $r;const Gr=typeof TextEncoder<"u";function Gn(e){if(Gr)e=($r||($r=new TextEncoder)).encode(e);else{let n=0;const r=new Uint8Array(3*e.length);for(let o=0;o<e.length;o++){var t=e.charCodeAt(o);if(t<128)r[n++]=t;else{if(t<2048)r[n++]=t>>6|192;else{if(t>=55296&&t<=57343){if(t<=56319&&o<e.length){const i=e.charCodeAt(++o);if(i>=56320&&i<=57343){t=1024*(t-55296)+i-56320+65536,r[n++]=t>>18|240,r[n++]=t>>12&63|128,r[n++]=t>>6&63|128,r[n++]=63&t|128;continue}o--}t=65533}r[n++]=t>>12|224,r[n++]=t>>6&63|128}r[n++]=63&t|128}}e=n===r.length?r:r.subarray(0,n)}return e}var Ut,zr=$n(610401301),Zt=$n(748402147);function en(){var e=ye.navigator;return e&&(e=e.userAgent)?e:""}const tn=ye.navigator;Ut=tn&&tn.userAgentData||null;var zn={},Ne=null;function Vr(e){const t=e.length;let n=3*t/4;n%3?n=Math.floor(n):"=.".indexOf(e[t-1])!=-1&&(n="=.".indexOf(e[t-2])!=-1?n-2:n-1);const r=new Uint8Array(n);let o=0;return function(i,s){function a(c){for(;l<i.length;){const u=i.charAt(l++),d=Ne[u];if(d!=null)return d;if(!/^[\s\xa0]*$/.test(u))throw Error("Unknown base64 encoding at char: "+u)}return c}Vn();let l=0;for(;;){const c=a(-1),u=a(0),d=a(64),f=a(64);if(f===64&&c===-1)break;s(c<<2|u>>4),d!=64&&(s(u<<4&240|d>>2),f!=64&&s(d<<6&192|f))}}(e,function(i){r[o++]=i}),o!==n?r.subarray(0,o):r}function Vn(){if(!Ne){Ne={};var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split(""),t=["+/=","+/","-_=","-_.","-_"];for(let n=0;n<5;n++){const r=e.concat(t[n].split(""));zn[n]=r;for(let o=0;o<r.length;o++){const i=r[o];Ne[i]===void 0&&(Ne[i]=o)}}}}var Hr=typeof Uint8Array<"u",Hn=!(!(zr&&Ut&&Ut.brands.length>0)&&(en().indexOf("Trident")!=-1||en().indexOf("MSIE")!=-1))&&typeof btoa=="function";const nn=/[-_.]/g,Wr={"-":"+",_:"/",".":"="};function qr(e){return Wr[e]||""}function rn(e){if(!Hn)return Vr(e);e=nn.test(e)?e.replace(nn,qr):e,e=atob(e);const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}function xt(e){return Hr&&e!=null&&e instanceof Uint8Array}var De={};function It(){return Yr||(Yr=new J(null,De))}var J=class{constructor(e,t){if(Wn(t),this.i=e,e!=null&&e.length===0)throw Error("ByteString should be constructed with non-empty values")}};let Yr,Kr;function Wn(e){if(e!==De)throw Error("illegal external caller")}function qn(e,t){e.__closure__error__context__984382||(e.__closure__error__context__984382={}),e.__closure__error__context__984382.severity=t}function je(e){return qn(e=Error(e),"warning"),e}function tt(e,t){if(e!=null){var n=Kr??(Kr={}),r=n[e]||0;r>=t||(n[e]=r+1,qn(e=Error(),"incident"),function(o){ye.setTimeout(()=>{throw o},0)}(e))}}var ct=typeof Symbol=="function"&&typeof Symbol()=="symbol";function ze(e,t,n=!1){return typeof Symbol=="function"&&typeof Symbol()=="symbol"?n&&Symbol.for&&e?Symbol.for(e):e!=null?Symbol(e):Symbol():t}var Jr=ze("jas",void 0,!0),Me=ze(void 0,"1oa"),Ct=ze(void 0,"0ubsb"),Xr=ze(void 0,"0actk"),ut=ze("m_m","na",!0);const Yn={fa:{value:0,configurable:!0,writable:!0,enumerable:!1}},Kn=Object.defineProperties,g=ct?Jr:"fa";var _e;const on=[];function Jn(e,t){ct||g in e||Kn(e,Yn),e[g]|=t}function x(e,t){ct||g in e||Kn(e,Yn),e[g]=t}function Vt(){return typeof BigInt=="function"}x(on,7),_e=Object.freeze(on);var ht={};function V(e,t){return t===void 0?e.i!==be&&!!(2&(0|e.m[g])):!!(2&t)&&e.i!==be}const be={};var Qr=Object.freeze({});function dt(e){return e.ma=!0,e}var Zr=dt(e=>typeof e=="number"),Xn=dt(e=>typeof e=="string"),eo=dt(e=>typeof e=="boolean"),ft=typeof ye.BigInt=="function"&&typeof ye.BigInt(0)=="bigint",to=dt(e=>ft?e>=ro&&e<=io:e[0]==="-"?sn(e,no):sn(e,oo));const no=Number.MIN_SAFE_INTEGER.toString(),ro=ft?BigInt(Number.MIN_SAFE_INTEGER):void 0,oo=Number.MAX_SAFE_INTEGER.toString(),io=ft?BigInt(Number.MAX_SAFE_INTEGER):void 0;function sn(e,t){if(e.length>t.length)return!1;if(e.length<t.length||e===t)return!0;for(let n=0;n<e.length;n++){const r=e[n],o=t[n];if(r>o)return!1;if(r<o)return!0}}let so,_=0,v=0;function an(e){const t=e>>>0;_=t,v=(e-t)/4294967296>>>0}function ve(e){if(e<0){an(-e);const[t,n]=Ht(_,v);_=t>>>0,v=n>>>0}else an(e)}function Qn(e,t){const n=4294967296*t+(e>>>0);return Number.isSafeInteger(n)?n:$e(e,t)}function $e(e,t){if(e>>>=0,(t>>>=0)<=2097151)var n=""+(4294967296*t+e);else Vt()?n=""+(BigInt(t)<<BigInt(32)|BigInt(e)):(e=(16777215&e)+6777216*(n=16777215&(e>>>24|t<<8))+6710656*(t=t>>16&65535),n+=8147497*t,t*=2,e>=1e7&&(n+=e/1e7>>>0,e%=1e7),n>=1e7&&(t+=n/1e7>>>0,n%=1e7),n=t+ln(n)+ln(e));return n}function ln(e){return e=String(e),"0000000".slice(e.length)+e}function mt(e){if(e.length<16)ve(Number(e));else if(Vt())e=BigInt(e),_=Number(e&BigInt(4294967295))>>>0,v=Number(e>>BigInt(32)&BigInt(4294967295));else{const t=+(e[0]==="-");v=_=0;const n=e.length;for(let r=t,o=(n-t)%6+t;o<=n;r=o,o+=6){const i=Number(e.slice(r,o));v*=1e6,_=1e6*_+i,_>=4294967296&&(v+=Math.trunc(_/4294967296),v>>>=0,_>>>=0)}if(t){const[r,o]=Ht(_,v);_=r,v=o}}}function Ht(e,t){return t=~t,e?e=1+~e:t+=1,[e,t]}function Ue(e){return Array.prototype.slice.call(e)}const ao=typeof BigInt=="function"?BigInt.asIntN:void 0,lo=typeof BigInt=="function"?BigInt.asUintN:void 0,xe=Number.isSafeInteger,Ie=Number.isFinite,nt=Math.trunc;function Tt(e){if(e!=null&&typeof e!="number")throw Error(`Value of float/double field must be a number, found ${typeof e}: ${e}`);return e}function Zn(e){return e==null||typeof e=="number"?e:e==="NaN"||e==="Infinity"||e==="-Infinity"?Number(e):void 0}function le(e){if(e!=null&&typeof e!="boolean"){var t=typeof e;throw Error(`Expected boolean but got ${t!="object"?t:e?Array.isArray(e)?"array":t:"null"}: ${e}`)}return e}function re(e){return e==null||typeof e=="boolean"?e:typeof e=="number"?!!e:void 0}const co=/^-?([1-9][0-9]*|0)(\.[0-9]+)?$/;function er(e){switch(typeof e){case"bigint":return!0;case"number":return Ie(e);case"string":return co.test(e);default:return!1}}function tr(e){if(typeof e!="number"||!Ie(e))throw je("int32");return 0|e}function kt(e){return e==null?e:tr(e)}function Te(e){if(e==null)return e;if(typeof e=="string"&&e)e=+e;else if(typeof e!="number")return;return Ie(e)?0|e:void 0}function rt(e){if(e==null)return e;if(typeof e=="string"&&e)e=+e;else if(typeof e!="number")return;return Ie(e)?e>>>0:void 0}function cn(e){if(e[0]==="-")return!1;const t=e.length;return t<20||t===20&&Number(e.substring(0,6))<184467}function uo(e){if(e==null)return e;var t=typeof e;if(t==="bigint")return String(lo(64,e));if(er(e)){if(t==="string")return t=nt(Number(e)),xe(t)&&t>=0?e=String(t):((t=e.indexOf("."))!==-1&&(e=e.substring(0,t)),cn(e)||(mt(e),e=$e(_,v))),e;if(t==="number")return(e=nt(e))>=0&&xe(e)?e:function(n){if(n<0){ve(n);var r=$e(_,v);return n=Number(r),xe(n)?n:r}return cn(r=String(n))?r:(ve(n),Qn(_,v))}(e)}}function Wt(e){return e==null||typeof e=="string"?e:void 0}function nr(e,t,n){if(e!=null&&e[ut]===ht)return e;if(Array.isArray(e)){var r=0|e[g];return(n=r|32&n|2&n)!==r&&x(e,n),new t(e)}}function pt(e,t,n,r){var o=r!==void 0;r=!!r;const i=[];var s=e.length;let a,l=4294967295,c=!1;const u=!!(64&t),d=u?128&t?0:-1:void 0;for(1&t||(a=s&&e[s-1],a!=null&&typeof a=="object"&&a.constructor===Object?l=--s:a=void 0,!u||128&t||o||(c=!0,l=l-d+d)),t=void 0,o=0;o<s;o++){let f=e[o];if(f!=null&&(f=n(f,r))!=null)if(u&&o>=l){const p=o-d;(t??(t={}))[p]=f}else i[o]=f}if(a)for(let f in a){if((e=a[f])==null||(e=n(e,r))==null)continue;let p;s=+f,u&&!Number.isNaN(s)&&(p=s+d)<l?i[p]=e:(t??(t={}))[f]=e}return t&&(c?i.push(t):i[l]=t),i}function qt(e){switch(typeof e){case"number":return Number.isFinite(e)?e:""+e;case"bigint":return to(e)?Number(e):""+e;case"boolean":return e?1:0;case"object":if(Array.isArray(e)){var t=0|e[g];return e.length===0&&1&t?void 0:pt(e,t,qt)}if(e!=null&&e[ut]===ht)return rr(e);if(e instanceof J){if((t=e.i)==null)e="";else if(typeof t=="string")e=t;else{if(Hn){for(var n="",r=0,o=t.length-10240;r<o;)n+=String.fromCharCode.apply(null,t.subarray(r,r+=10240));n+=String.fromCharCode.apply(null,r?t.subarray(r):t),t=btoa(n)}else{n===void 0&&(n=0),Vn(),n=zn[n],r=Array(Math.floor(t.length/3)),o=n[64]||"";let c=0,u=0;for(;c<t.length-2;c+=3){var i=t[c],s=t[c+1],a=t[c+2],l=n[i>>2];i=n[(3&i)<<4|s>>4],s=n[(15&s)<<2|a>>6],a=n[63&a],r[u++]=l+i+s+a}switch(l=0,a=o,t.length-c){case 2:a=n[(15&(l=t[c+1]))<<2]||o;case 1:t=t[c],r[u]=n[t>>2]+n[(3&t)<<4|l>>4]+a+o}t=r.join("")}e=e.i=t}return e}return}return e}function rr(e){return pt(e=e.m,0|e[g],qt)}let ho,fo;function mo(e,t,n){return or(e,t[0],t[1],2)}function or(e,t,n,r=0){if(e==null){var o=32;n?(e=[n],o|=128):e=[],t&&(o=-8380417&o|(1023&t)<<13)}else{if(!Array.isArray(e))throw Error("narr");if(o=0|e[g],Zt&&1&o)throw Error("rfarr");if(2048&o&&!(2&o)&&function(){if(Zt)throw Error("carr");tt(Xr,5)}(),256&o)throw Error("farr");if(64&o)return r!==0||2048&o||x(e,2048|o),e;if(n&&(o|=128,n!==e[0]))throw Error("mid");e:{o|=64;var i=(n=e).length;if(i){var s=i-1;const l=n[s];if(l!=null&&typeof l=="object"&&l.constructor===Object){if((s-=t=128&o?0:-1)>=1024)throw Error("pvtlmt");for(var a in l)(i=+a)<s&&(n[i+t]=l[a],delete l[a]);o=-8380417&o|(1023&s)<<13;break e}}if(t){if((a=Math.max(t,i-(128&o?0:-1)))>1024)throw Error("spvt");o=-8380417&o|(1023&a)<<13}}}return o|=64,r===0&&(o|=2048),x(e,o),e}function po(e,t){if(typeof e!="object")return e;if(Array.isArray(e)){var n=0|e[g];return e.length===0&&1&n?e=void 0:2&n||(!t||4096&n||16&n?e=ot(e,n,!1,t&&!(16&n)):(Jn(e,34),4&n&&Object.freeze(e))),e}return e!=null&&e[ut]===ht?V(e,n=0|(t=e.m)[g])?e:sr(e,t,n)?ir(e,t):ot(t,n):e instanceof J?e:void 0}function ir(e,t,n){return e=new e.constructor(t),n&&(e.i=be),e.o=be,e}function ot(e,t,n,r){return r??(r=!!(34&t)),e=pt(e,t,po,r),r=32,n&&(r|=2),x(e,t=8380609&t|r),e}function gt(e){if(e.i!==be)return!1;var t=e.m;return Jn(t=ot(t,0|t[g]),2048),e.m=t,e.i=void 0,e.o=void 0,!0}function Pe(e){if(!gt(e)&&V(e,0|e.m[g]))throw Error()}function Se(e,t){t===void 0&&(t=0|e[g]),32&t&&!(4096&t)&&x(e,4096|t)}function sr(e,t,n){return!!(2&n)||!(!(32&n)||4096&n)&&(x(t,2|n),e.i=be,!0)}function j(e,t,n){if((e=wt(e.m,t,void 0,n))!==null)return e}function wt(e,t,n,r){if(t===-1)return null;const o=t+(n?0:-1),i=e.length-1;let s,a;if(!(i<1+(n?0:-1))){if(o>=i)if(s=e[i],s!=null&&typeof s=="object"&&s.constructor===Object)n=s[t],a=!0;else{if(o!==i)return;n=s}else n=e[o];if(r&&n!=null){if((r=r(n))==null)return r;if(!Object.is(r,n))return a?s[t]=r:e[o]=r,r}return n}}function ue(e,t,n){Pe(e),W(e=e.m,0|e[g],t,n)}function W(e,t,n,r,o){const i=n+-1;var s=e.length-1;if(s>=0&&i>=s){const a=e[s];if(a!=null&&typeof a=="object"&&a.constructor===Object)return a[n]=r,t}return i<=s?(e[i]=r,t):(r!==void 0&&(n>=(s=(t??(t=0|e[g]))>>13&1023||536870912)?r!=null&&(e[s+-1]={[n]:r}):e[i]=r),t)}function ar(e,t,n,r,o){let i=e.m,s=0|i[g];r=V(e,s)?1:r,o=!!o||r===3,r===2&&gt(e)&&(i=e.m,s=0|i[g]);let a=(e=cr(i,t))===_e?7:0|e[g],l=ur(a,s);var c=!(4&l);if(c){4&l&&(e=Ue(e),a=0,l=Ce(l,s),s=W(i,s,t,e));let u=0,d=0;for(;u<e.length;u++){const f=n(e[u]);f!=null&&(e[d++]=f)}d<u&&(e.length=d),n=-513&(4|l),l=n&=-1025,l&=-4097}return l!==a&&(x(e,l),2&l&&Object.freeze(e)),lr(e,l,i,s,t,r,c,o)}function lr(e,t,n,r,o,i,s,a){let l=t;return i===1||i===4&&(2&t||!(16&t)&&32&r)?Qe(t)||((t|=!e.length||s&&!(4096&t)||32&r&&!(4096&t||16&t)?2:256)!==l&&x(e,t),Object.freeze(e)):(i===2&&Qe(t)&&(e=Ue(e),l=0,t=Ce(t,r),r=W(n,r,o,e)),Qe(t)||(a||(t|=16),t!==l&&x(e,t))),2&t||!(4096&t||16&t)||Se(n,r),e}function cr(e,t,n){return e=wt(e,t,n),Array.isArray(e)?e:_e}function ur(e,t){return 2&t&&(e|=2),1|e}function Qe(e){return!!(2&e)&&!!(4&e)||!!(256&e)}function hr(e,t,n){Pe(e);let r=0|(e=e.m)[g];if(n==null)W(e,r,t);else{var o=n===_e?7:0|n[g],i=o,s=Qe(o),a=s||Object.isFrozen(n);for(s||(o=0),a||(n=Ue(n),i=0,o=Ce(o,r),a=!1),o|=5,s=0;s<n.length;s++){const l=n[s],c=tr(l);Object.is(l,c)||(a&&(n=Ue(n),i=0,o=Ce(o,r),a=!1),n[s]=c)}o!==i&&(a&&(n=Ue(n),o=Ce(o,r)),x(n,o)),W(e,r,t,n)}}function D(e,t,n,r){Pe(e),W(e=e.m,0|e[g],t,(r==="0"?Number(n)===0:n===r)?void 0:n)}function un(e){if(ct)return e[Me]??(e[Me]=new Map);if(Me in e)return e[Me];const t=new Map;return Object.defineProperty(e,Me,{value:t}),t}function hn(e,t,n){var r=at;let o=e.get(r);if(o!=null)return o;o=0;for(let i=0;i<r.length;i++){const s=r[i];wt(t,s)!=null&&(o!==0&&(n=W(t,n,o)),o=s)}return e.set(r,o),o}function Ge(e,t,n){let r=e.m,o=0|r[g];if(t=function(a,l,c,u){let d=!1;if((u=wt(a,u,void 0,f=>{const p=nr(f,c,l);return d=p!==f&&p!=null,p}))!=null)return d&&!V(u)&&Se(a,l),u}(r,o,t,n),t==null)return t;if(o=0|r[g],!V(e,o)){var i,s=t;const a=s.m,l=0|a[g];(i=V(s,l)?sr(s,a,l)?ir(s,a,!0):new s.constructor(ot(a,l,!1)):s)!==t&&(gt(e)&&(r=e.m,o=0|r[g]),o=W(r,o,n,t=i),Se(r,o))}return t}function dr(e){return e==null&&(e=void 0),e}function ne(e,t,n){return ue(e,t,n=dr(n)),n&&!V(n)&&Se(e.m),e}function Ce(e,t){return-273&(2&t?2|e:-3&e)}function Fe(e,t,n,r){var o=r;Pe(e);var i=r=e.m,s=0|r[g];const a=V(e,s)?1:2;a===2&&gt(e)&&(s=0|(i=e.m)[g]);let l=(e=cr(i,t))===_e?7:0|e[g];var c=ur(l,s);const u=!(4&c);if(u){var d=e,f=s;const p=!!(2&c);p&&(f|=2);let y=!p,E=!0,b=0,N=0;for(;b<d.length;b++){const P=nr(d[b],n,f);if(P instanceof n){if(!p){const C=V(P);y&&(y=!C),E&&(E=C)}d[N++]=P}}N<b&&(d.length=N),c|=4,c=E?-4097&c:4096|c,c=y?8|c:-9&c}c!==l&&(x(e,c),2&c&&Object.freeze(e)),t=e=lr(e,c,i,s,t,a,u,!0),o=o??new n,t.push(o),i=n=t===_e?7:0|t[g],(o=V(o))?(n&=-9,t.length===1&&(n&=-4097)):n|=4096,n!==i&&x(t,n),o||Se(r)}function O(e,t){return rt(j(e,t))??0}function H(e,t,n){D(e,t,kt(n),0)}function Le(e,t,n){if(n!=null){if(typeof n!="number"||!Ie(n))throw je("uint32");n>>>=0}ue(e,t,n)}function F(e,t,n){if(n!=null&&typeof n!="string")throw Error();D(e,t,n,"")}function m(e,t,n){if(Pe(e),t=(e=ar(e,t,Wt,2,!0)).push,typeof n!="string")throw Error();t.call(e,n)}var he=class{constructor(e,t,n){if(this.buffer=e,n&&!t)throw Error()}};function dn(e){if(typeof e=="string")return new he(rn(e),!0);if(Array.isArray(e))return new he(new Uint8Array(e),!0);if(e.constructor===Uint8Array)return new he(e,!1);if(e.constructor===ArrayBuffer)return e=new Uint8Array(e),new he(e,!1);if(e.constructor===J){Wn(De);var t=e.i;return t=((t=t==null||xt(t)?t:typeof t=="string"?rn(t):null)==null?t:e.i=t)||new Uint8Array(0),new he(t,!0,e)}if(e instanceof Uint8Array)return e=e.constructor===Uint8Array?e:new Uint8Array(e.buffer,e.byteOffset,e.byteLength),new he(e,!1);throw Error()}function fn(e){return e?/^\d+$/.test(e)?(mt(e),new Rt(_,v)):null:go||(go=new Rt(0,0))}var Rt=class{constructor(e,t){this.j=e>>>0,this.i=t>>>0}};let go;function mn(e){return e?/^-?\d+$/.test(e)?(mt(e),new Bt(_,v)):null:wo||(wo=new Bt(0,0))}var Bt=class{constructor(e,t){this.j=e>>>0,this.i=t>>>0}};let wo;function ge(e,t,n){for(;n>0||t>127;)e.i.push(127&t|128),t=(t>>>7|n<<25)>>>0,n>>>=7;e.i.push(t)}function yt(e,t){for(;t>127;)e.i.push(127&t|128),t>>>=7;e.i.push(t)}function _t(e,t){if(t>=0)yt(e,t);else{for(let n=0;n<9;n++)e.i.push(127&t|128),t>>=7;e.i.push(1)}}function it(e,t){t.length!==0&&(e.l.push(t),e.j+=t.length)}function Q(e,t,n){yt(e.i,8*t+n)}function bt(e,t){return Q(e,t,2),t=e.i.end(),it(e,t),t.push(e.j),t}function vt(e,t){var n=t.pop();for(n=e.j+e.i.length()-n;n>127;)t.push(127&n|128),n>>>=7,e.j++;t.push(n),e.j++}function st(e,t,n){Q(e,t,2),yt(e.i,n.length),it(e,e.i.end()),it(e,n)}function q(){const e=class{constructor(){throw Error()}};return Object.setPrototypeOf(e,e.prototype),e}var Ve=q(),fr=q(),St=q(),At=q(),yo=q(),_o=q(),bo=q(),mr=q(),vo=q(),Yt=q(),A=class{constructor(e,t){this.m=or(e,t)}toJSON(){return rr(this)}};A.prototype[ut]=ht,A.prototype.toString=function(){return this.m.toString()};var Y=class{constructor(e,t){this.i=e,e=Ve,this.j=!!e&&t===e||!1}};function pr(e,t,n,r,o){(t=wr(t,r))!=null&&(n=bt(e,n),o(t,e),vt(e,n))}const So=new Y(pr,Ve),Ao=new Y(pr,Ve);var pn=Symbol(),gn=Symbol();let gr;function Et(e){var t=Eo,n=Io,r=e[pn];if(r)return r;(r={}).la=e,r.W=function(u){switch(typeof u){case"boolean":return ho||(ho=[0,void 0,!0]);case"number":return u>0?void 0:u===0?fo||(fo=[0,void 0]):[-u,void 0];case"string":return[0,u];case"object":return u}}(e[0]);var o=e[1];let i=1;o&&o.constructor===Object&&(r.ba=o,typeof(o=e[++i])=="function"&&(r.ga=!0,gr??(gr=e[i+1]),o=e[i+=2]));const s={};for(;o&&Array.isArray(o)&&o.length&&typeof o[0]=="number"&&o[0]>0;){for(var a=0;a<o.length;a++)s[o[a]]=o;o=e[++i]}for(a=1;o!==void 0;){let u;typeof o=="number"&&(a+=o,o=e[++i]);var l=void 0;if(o instanceof Y?u=o:(u=So,i--),u==null?void 0:u.j){o=e[++i],l=e;var c=i;typeof o=="function"&&(o=o(),l[c]=o),l=o}for(c=a+1,typeof(o=e[++i])=="number"&&o<0&&(c-=o,o=e[++i]);a<c;a++)l?n(r,a,u,l):t(r,a,u)}return e[pn]=r}function wr(e,t){return e instanceof A?e.m:Array.isArray(e)?mo(e,t):void 0}function Eo(e,t,n){e[t]=n.i}function Io(e,t,n,r){let o,i;const s=n.i;e[t]=(a,l,c)=>s(a,l,c,i||(i=Et(r).W),o||(o=yr(r)))}function yr(e){let t=e[gn];if(!t){const n=Et(e);t=(r,o)=>_r(r,o,n),e[gn]=t}return t}function _r(e,t,n){(function(r,o,i){const s=128&o?0:-1,a=r.length;var l;(l=!!a)&&(l=(l=r[a-1])!=null&&typeof l=="object"&&l.constructor===Object);const c=a+(l?-1:0);for(o=128&o?1:0;o<c;o++)i(o-s,r[o]);if(l){r=r[a-1];for(const u in r)!isNaN(u)&&i(+u,r[u])}})(e,0|e[g],(r,o)=>{if(o!=null){var i=function(s,a){var l=s[a];if(l)return l;if((l=s.ba)&&(l=l[a])){var c=(l=Array.isArray(l)?l[0]instanceof Y?l:[Ao,l]:[l,void 0])[0].i;if(l=l[1]){const u=yr(l),d=Et(l).W;l=s.ga?gr(d,u):(f,p,y)=>c(f,p,y,d,u)}else l=c;return s[a]=l}}(n,r);i?i(t,o,r):r<500||tt(Ct,3)}})}var Pt,se=0,de=se;if(Xn(de)){if(!/^\s*(?:-?[1-9]\d*|0)?\s*$/.test(de))throw Error(String(de))}else if((Pt=Zr(de))&&(Pt=!Number.isSafeInteger(de)),Pt)throw Error(String(de));function Kt(e,t){if(Array.isArray(t)){var n=0|t[g];if(4&n)return t;for(var r=0,o=0;r<t.length;r++){const i=e(t[r]);i!=null&&(t[o++]=i)}return o<r&&(t.length=o),x(t,-1537&(5|n)),2&n&&Object.freeze(t),t}}function L(e,t){return new Y(e,t)}function br(e,t,n){(t=Zn(t))!=null&&(Q(e,n,5),e=e.i,(n=so||(so=new DataView(new ArrayBuffer(8)))).setFloat32(0,+t,!0),v=0,t=_=n.getUint32(0,!0),e.i.push(t>>>0&255),e.i.push(t>>>8&255),e.i.push(t>>>16&255),e.i.push(t>>>24&255))}function Jt(e,t,n){(t=Te(t))!=null&&t!=null&&(Q(e,n,0),_t(e.i,t))}function vr(e,t,n){(t=re(t))!=null&&(Q(e,n,0),e.i.i.push(t?1:0))}function Xt(e,t,n){(t=Wt(t))!=null&&st(e,n,Gn(t))}function Sr(e,t,n,r,o){(t=wr(t,r))!=null&&(n=bt(e,n),o(t,e),vt(e,n))}function Ar(e,t,n){(t=Te(t))!=null&&(t=parseInt(t,10),Q(e,n,0),_t(e.i,t))}ft||(se=eo(se)?se?"1":"0":Xn(se)?se.trim()||"0":String(se));var Ae,qe=L(br,mr),Dt=L(br,mr),Mt=L(function(e,t,n){if(t=function(r){if(r==null)return r;var o=typeof r;if(o==="bigint")return String(ao(64,r));if(er(r)){if(o==="string"){if(o=nt(Number(r)),xe(o))r=String(o);else if((o=r.indexOf("."))!==-1&&(r=r.substring(0,o)),o=r.length,!(r[0]==="-"?o<20||o===20&&Number(r.substring(0,7))>-922337:o<19||o===19&&Number(r.substring(0,6))<922337))if(mt(r),r=_,2147483648&(o=v))if(Vt())r=""+(BigInt(0|o)<<BigInt(32)|BigInt(r>>>0));else{const[s,a]=Ht(r,o);r="-"+$e(s,a)}else r=$e(r,o);return r}if(o==="number"){if(r=nt(r),!xe(r)){ve(r),o=_;var i=v;(r=2147483648&i)&&(i=~i>>>0,(o=1+~o>>>0)==0&&(i=i+1>>>0)),r=typeof(o=Qn(o,i))=="number"?r?-o:o:r?"-"+o:o}return r}}}(t),t!=null&&(typeof t=="string"&&mn(t),t!=null))switch(Q(e,n,0),typeof t){case"number":e=e.i,ve(t),ge(e,_,v);break;case"bigint":n=BigInt.asUintN(64,t),n=new Bt(Number(n&BigInt(4294967295)),Number(n>>BigInt(32))),ge(e.i,n.j,n.i);break;default:n=mn(t),ge(e.i,n.j,n.i)}},_o),To=L(function(e,t,n){if((t=uo(t))!=null&&(typeof t=="string"&&fn(t),t!=null))switch(Q(e,n,0),typeof t){case"number":e=e.i,ve(t),ge(e,_,v);break;case"bigint":n=BigInt.asUintN(64,t),n=new Rt(Number(n&BigInt(4294967295)),Number(n>>BigInt(32))),ge(e.i,n.j,n.i);break;default:n=fn(t),ge(e.i,n.j,n.i)}},bo),z=L(Jt,At);Ae=new Y(function(e,t,n){if((t=Kt(Te,t))!=null&&t.length){n=bt(e,n);for(let r=0;r<t.length;r++)_t(e.i,t[r]);vt(e,n)}},At);var U,w=L(Jt,At),Po=L(Jt,At),I=L(vr,fr),S=L(vr,fr),T=L(Xt,St);U=new Y(function(e,t,n){if((t=Kt(Wt,t))!=null)for(let s=0;s<t.length;s++){var r=e,o=n,i=t[s];i!=null&&st(r,o,Gn(i))}},St);var Qt,R=L(Xt,St),Er=L(Xt,St),G=function(e,t,n=Ve){return new Y(t,n)}(0,function(e,t,n,r,o){if(Array.isArray(t))for(let i=0;i<t.length;i++)Sr(e,t[i],n,r,o)}),B=new Y(Sr,Ve),Mo=L(function(e,t,n){(t=rt(t))!=null&&t!=null&&(Q(e,n,0),yt(e.i,t))},yo),te=L(Ar,Yt);Qt=new Y(function(e,t,n){if((t=Kt(Te,t))!=null&&t.length){n=bt(e,n);for(let r=0;r<t.length;r++)_t(e.i,t[r]);vt(e,n)}},Yt);var X=L(Ar,Yt);function He(e){return function(){const t=new class{constructor(){this.l=[],this.j=0,this.i=new class{constructor(){this.i=[]}length(){return this.i.length}end(){const s=this.i;return this.i=[],s}}}};_r(this.m,t,Et(e)),it(t,t.i.end());const n=new Uint8Array(t.j),r=t.l,o=r.length;let i=0;for(let s=0;s<o;s++){const a=r[s];n.set(a,i),i+=a.length}return t.l=[n],n}}function Lt(e,t){if(t!=null)if(Array.isArray(t))ue(e,2,pt(t,0,qt));else{if(!(typeof t=="string"||t instanceof J||xt(t)))throw Error("invalid value in Any.value field: "+t+" expected a ByteString, a base64 encoded string, a Uint8Array or a jspb array");if(t!=null){if(typeof t=="string")t=t?new J(t,De):It();else if(t.constructor!==J){if(!xt(t))throw Error();t=t.length?new J(new Uint8Array(t),De):It()}}D(e,2,t,It())}}var fe=class extends A{constructor(e){super(e)}},wn=[0,R,L(function(e,t,n){if(t!=null){if(t instanceof A){const r=t.oa;return void(r?(t=r(t),t!=null&&st(e,n,dn(t).buffer)):tt(Ct,3))}if(Array.isArray(t))return void tt(Ct,3)}(t=t==null||typeof t=="string"||t instanceof J?t:void 0)!=null&&st(e,n,dn(t).buffer)},vo)];let Ot,yn=globalThis.trustedTypes;function _n(e){var t;return Ot===void 0&&(Ot=function(){let n=null;if(!yn)return n;try{const r=o=>o;n=yn.createPolicy("goog#html",{createHTML:r,createScript:r,createScriptURL:r})}catch{}return n}()),e=(t=Ot)?t.createScriptURL(e):e,new class{constructor(n){this.i=n}toString(){return this.i+""}}(e)}function Lo(e,...t){if(t.length===0)return _n(e[0]);let n=e[0];for(let r=0;r<t.length;r++)n+=encodeURIComponent(t[r])+e[r+1];return _n(n)}var Ir={};Ir[336783863]=[0,T,I,-1,z,[0,[1,2,3,4,5,6,7,8,9],B,[0],B,[0,I,T,I,te,-1,Qt,T,-1,[0,I,-1],te,I,-1],B,[0,T,-2],B,[0,z,I,1,I,-3],B,[0,z,te,I,-1,Ae,te,-1,I],B,[0,T,-2],B,[0,T,te],B,[0,te,T,-1,I],B,[0,te,-1]],[0,T],I,[0,[1,3],[2,4],B,[0,Ae],-1,B,[0,U],-1,G,[0,T,-1]],T];var bn=class extends A{constructor(e){super(e)}},vn=[0,Mt,-1,S,-3,Mt,Ae,R,w,Mt,-1,S,w,S,-2,R],K=class extends A{constructor(e){super(e,500)}N(e){return ne(this,7,e)}},ke=[-1,{}],Sn=[0,T,1,ke],An=[0,T,U,ke];function Z(e,t){Fe(e,1,K,t)}var Tr=class extends A{constructor(e){super(e,500)}N(e){return ne(this,1001,e)}};Tr.prototype.j=He([-500,G,[-500,R,-1,U,-3,[-2,Ir,I],G,wn,w,-1,Sn,An,G,[0,R,S],R,vn,w,U,987,U],4,G,[-500,T,-1,[-1,{}],998,T],G,[-500,T,U,-1,[-2,{},I],997,U,-1],w,G,[-500,T,U,ke,998,U],U,w,Sn,An,G,[0,R,-1,ke],U,-2,vn,R,-1,S,[0,S,Mo],978,ke,G,wn]);var En=class extends A{constructor(e){super(e)}};let Ye;const Oo=new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]);async function Pr(){if(Ye===void 0)try{await WebAssembly.instantiate(Oo),Ye=!0}catch{Ye=!1}return Ye}async function Oe(e,t=Lo``){const n=await Pr()?"wasm_internal":"wasm_nosimd_internal";return{wasmLoaderPath:`${t}/${e}_${n}.js`,wasmBinaryPath:`${t}/${e}_${n}.wasm`}}var ae=class{};function In(e){function t(s,a){return new ReadableStream({start(){},async pull(l){o=o.then(async()=>{if(s.cache.length>0)l.enqueue(s.cache.shift());else{var{value:c,done:u}=await e.read();c&&(a.active&&a.cache.push(c),s.active&&l.enqueue(c)),u&&l.close()}}),await o},cancel(){s.active=!1,s.cache.length=0,a.active||e.cancel()}})}var n={cache:[],active:!0};const r={cache:[],active:!0};let o=Promise.resolve();const i=t(n,r);return n=t(r,n),[i.getReader(),n.getReader()]}async function Tn(e,t){const n=new Uint8Array(t);let r=0;for(;r<t;){const{value:o,done:i}=await e.read();if(o){const s=o.subarray(0,t-r);n.set(s,r),r+=s.length}if(i)throw Error(`Expected ${t} bytes, but stream ended after reading ${r} bytes.`)}return await e.cancel(),n}ae.forVisionTasks=function(e){return Oe("vision",e)},ae.forTextTasks=function(e){return Oe("text",e)},ae.forGenAiExperimentalTasks=function(e){return Oe("genai_experimental",e)},ae.forGenAiTasks=function(e){return Oe("genai",e)},ae.forAudioTasks=function(e){return Oe("audio",e)},ae.isSimdSupported=function(){return Pr()};const No=[[0,async e=>{const t=new TextEncoder().encode("TFL3").length;return e=await Tn(e,t+4),new TextDecoder("utf-8").decode(e.subarray(4,t+4))==="TFL3"}],[1,async e=>(e=await Tn(e,6))[4]===80&&e[5]===75]];function Fo(){var e=navigator;return typeof OffscreenCanvas<"u"&&(!function(t=navigator){return(t=t.userAgent).includes("Safari")&&!t.includes("Chrome")}(e)||!!((e=e.userAgent.match(/Version\/([\d]+).*Safari/))&&e.length>=1&&Number(e[1])>=17))}async function Pn(e){if(typeof importScripts!="function"){const t=document.createElement("script");return t.src=e.toString(),t.crossOrigin="anonymous",new Promise((n,r)=>{t.addEventListener("load",()=>{n()},!1),t.addEventListener("error",o=>{r(o)},!1),document.body.appendChild(t)})}importScripts(e.toString())}function h(e,t,n){e.o||console.error("No wasm multistream support detected: ensure dependency inclusion of :gl_graph_runner_internal_multi_input target"),n(t=e.h.stringToNewUTF8(t)),e.h._free(t)}function Mn(e,t,n){e.o||console.error("No wasm multistream support detected: ensure dependency inclusion of :gl_graph_runner_internal_multi_input target");const r=new Uint32Array(t.length);for(let o=0;o<t.length;o++)r[o]=e.h.stringToNewUTF8(t[o]);t=e.h._malloc(4*r.length),e.h.HEAPU32.set(r,t>>2),n(t);for(const o of r)e.h._free(o);e.h._free(t)}function ee(e,t,n){e.h.simpleListeners=e.h.simpleListeners||{},e.h.simpleListeners[t]=n}function oe(e,t,n){let r=[];e.h.simpleListeners=e.h.simpleListeners||{},e.h.simpleListeners[t]=(o,i,s)=>{i?(n(r,s),r=[]):r.push(o)}}const Uo=(Ln=class{constructor(e,t){this.l=!0,this.h=e,this.i=null,this.j=0,this.o=typeof this.h._addIntToInputStream=="function",t!==void 0?this.h.canvas=t:Fo()?this.h.canvas=new OffscreenCanvas(1,1):(console.warn("OffscreenCanvas not supported and GraphRunner constructor glCanvas parameter is undefined. Creating backup canvas."),this.h.canvas=document.createElement("canvas"))}async initializeGraph(e){const t=await(await fetch(e)).arrayBuffer();e=!(e.endsWith(".pbtxt")||e.endsWith(".textproto")),this.setGraph(new Uint8Array(t),e)}setGraphFromString(e){this.setGraph(new TextEncoder().encode(e),!1)}setGraph(e,t){const n=e.length,r=this.h._malloc(n);this.h.HEAPU8.set(e,r),t?this.h._changeBinaryGraph(n,r):this.h._changeTextGraph(n,r),this.h._free(r)}configureAudio(e,t,n,r,o){this.h._configureAudio||console.warn('Attempting to use configureAudio without support for input audio. Is build dep ":gl_graph_runner_audio" missing?'),h(this,r||"input_audio",i=>{h(this,o=o||"audio_header",s=>{this.h._configureAudio(i,s,e,t??0,n)})})}setAutoResizeCanvas(e){this.l=e}setAutoRenderToScreen(e){this.h._setAutoRenderToScreen(e)}setGpuBufferVerticalFlip(e){this.h.gpuOriginForWebTexturesIsBottomLeft=e}attachErrorListener(e){this.h.errorListener=e}attachEmptyPacketListener(e,t){this.h.emptyPacketListeners=this.h.emptyPacketListeners||{},this.h.emptyPacketListeners[e]=t}addAudioToStream(e,t,n){this.addAudioToStreamWithShape(e,0,0,t,n)}addAudioToStreamWithShape(e,t,n,r,o){const i=4*e.length;this.j!==i&&(this.i&&this.h._free(this.i),this.i=this.h._malloc(i),this.j=i),this.h.HEAPF32.set(e,this.i/4),h(this,r,s=>{this.h._addAudioToInputStream(this.i,t,n,s,o)})}addGpuBufferToStream(e,t,n){h(this,t,r=>{if(!this.h.canvas)throw Error("No OpenGL canvas configured.");r?this.h._bindTextureToStream(r):this.h._bindTextureToCanvas();const o=this.h.canvas.getContext("webgl2")||this.h.canvas.getContext("webgl");if(!o)throw Error("Failed to obtain WebGL context from the provided canvas. `getContext()` should only be invoked with `webgl` or `webgl2`.");this.h.gpuOriginForWebTexturesIsBottomLeft&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!0),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,e),this.h.gpuOriginForWebTexturesIsBottomLeft&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!1);const[i,s]=e.videoWidth!==void 0?[e.videoWidth,e.videoHeight]:e.naturalWidth!==void 0?[e.naturalWidth,e.naturalHeight]:e.displayWidth!==void 0?[e.displayWidth,e.displayHeight]:[e.width,e.height];!this.l||i===this.h.canvas.width&&s===this.h.canvas.height||(this.h.canvas.width=i,this.h.canvas.height=s);const[a,l]=[i,s];this.h._addBoundTextureToStream(r,a,l,n)})}addBoolToStream(e,t,n){h(this,t,r=>{this.h._addBoolToInputStream(e,r,n)})}addDoubleToStream(e,t,n){h(this,t,r=>{this.h._addDoubleToInputStream(e,r,n)})}addFloatToStream(e,t,n){h(this,t,r=>{this.h._addFloatToInputStream(e,r,n)})}addIntToStream(e,t,n){h(this,t,r=>{this.h._addIntToInputStream(e,r,n)})}addUintToStream(e,t,n){h(this,t,r=>{this.h._addUintToInputStream(e,r,n)})}addStringToStream(e,t,n){h(this,t,r=>{h(this,e,o=>{this.h._addStringToInputStream(o,r,n)})})}addStringRecordToStream(e,t,n){h(this,t,r=>{Mn(this,Object.keys(e),o=>{Mn(this,Object.values(e),i=>{this.h._addFlatHashMapToInputStream(o,i,Object.keys(e).length,r,n)})})})}addProtoToStream(e,t,n,r){h(this,n,o=>{h(this,t,i=>{const s=this.h._malloc(e.length);this.h.HEAPU8.set(e,s),this.h._addProtoToInputStream(s,e.length,i,o,r),this.h._free(s)})})}addEmptyPacketToStream(e,t){h(this,e,n=>{this.h._addEmptyPacketToInputStream(n,t)})}addBoolVectorToStream(e,t,n){h(this,t,r=>{const o=this.h._allocateBoolVector(e.length);if(!o)throw Error("Unable to allocate new bool vector on heap.");for(const i of e)this.h._addBoolVectorEntry(o,i);this.h._addBoolVectorToInputStream(o,r,n)})}addDoubleVectorToStream(e,t,n){h(this,t,r=>{const o=this.h._allocateDoubleVector(e.length);if(!o)throw Error("Unable to allocate new double vector on heap.");for(const i of e)this.h._addDoubleVectorEntry(o,i);this.h._addDoubleVectorToInputStream(o,r,n)})}addFloatVectorToStream(e,t,n){h(this,t,r=>{const o=this.h._allocateFloatVector(e.length);if(!o)throw Error("Unable to allocate new float vector on heap.");for(const i of e)this.h._addFloatVectorEntry(o,i);this.h._addFloatVectorToInputStream(o,r,n)})}addIntVectorToStream(e,t,n){h(this,t,r=>{const o=this.h._allocateIntVector(e.length);if(!o)throw Error("Unable to allocate new int vector on heap.");for(const i of e)this.h._addIntVectorEntry(o,i);this.h._addIntVectorToInputStream(o,r,n)})}addUintVectorToStream(e,t,n){h(this,t,r=>{const o=this.h._allocateUintVector(e.length);if(!o)throw Error("Unable to allocate new unsigned int vector on heap.");for(const i of e)this.h._addUintVectorEntry(o,i);this.h._addUintVectorToInputStream(o,r,n)})}addStringVectorToStream(e,t,n){h(this,t,r=>{const o=this.h._allocateStringVector(e.length);if(!o)throw Error("Unable to allocate new string vector on heap.");for(const i of e)h(this,i,s=>{this.h._addStringVectorEntry(o,s)});this.h._addStringVectorToInputStream(o,r,n)})}addBoolToInputSidePacket(e,t){h(this,t,n=>{this.h._addBoolToInputSidePacket(e,n)})}addDoubleToInputSidePacket(e,t){h(this,t,n=>{this.h._addDoubleToInputSidePacket(e,n)})}addFloatToInputSidePacket(e,t){h(this,t,n=>{this.h._addFloatToInputSidePacket(e,n)})}addIntToInputSidePacket(e,t){h(this,t,n=>{this.h._addIntToInputSidePacket(e,n)})}addUintToInputSidePacket(e,t){h(this,t,n=>{this.h._addUintToInputSidePacket(e,n)})}addStringToInputSidePacket(e,t){h(this,t,n=>{h(this,e,r=>{this.h._addStringToInputSidePacket(r,n)})})}addProtoToInputSidePacket(e,t,n){h(this,n,r=>{h(this,t,o=>{const i=this.h._malloc(e.length);this.h.HEAPU8.set(e,i),this.h._addProtoToInputSidePacket(i,e.length,o,r),this.h._free(i)})})}addBoolVectorToInputSidePacket(e,t){h(this,t,n=>{const r=this.h._allocateBoolVector(e.length);if(!r)throw Error("Unable to allocate new bool vector on heap.");for(const o of e)this.h._addBoolVectorEntry(r,o);this.h._addBoolVectorToInputSidePacket(r,n)})}addDoubleVectorToInputSidePacket(e,t){h(this,t,n=>{const r=this.h._allocateDoubleVector(e.length);if(!r)throw Error("Unable to allocate new double vector on heap.");for(const o of e)this.h._addDoubleVectorEntry(r,o);this.h._addDoubleVectorToInputSidePacket(r,n)})}addFloatVectorToInputSidePacket(e,t){h(this,t,n=>{const r=this.h._allocateFloatVector(e.length);if(!r)throw Error("Unable to allocate new float vector on heap.");for(const o of e)this.h._addFloatVectorEntry(r,o);this.h._addFloatVectorToInputSidePacket(r,n)})}addIntVectorToInputSidePacket(e,t){h(this,t,n=>{const r=this.h._allocateIntVector(e.length);if(!r)throw Error("Unable to allocate new int vector on heap.");for(const o of e)this.h._addIntVectorEntry(r,o);this.h._addIntVectorToInputSidePacket(r,n)})}addUintVectorToInputSidePacket(e,t){h(this,t,n=>{const r=this.h._allocateUintVector(e.length);if(!r)throw Error("Unable to allocate new unsigned int vector on heap.");for(const o of e)this.h._addUintVectorEntry(r,o);this.h._addUintVectorToInputSidePacket(r,n)})}addStringVectorToInputSidePacket(e,t){h(this,t,n=>{const r=this.h._allocateStringVector(e.length);if(!r)throw Error("Unable to allocate new string vector on heap.");for(const o of e)h(this,o,i=>{this.h._addStringVectorEntry(r,i)});this.h._addStringVectorToInputSidePacket(r,n)})}attachBoolListener(e,t){ee(this,e,t),h(this,e,n=>{this.h._attachBoolListener(n)})}attachBoolVectorListener(e,t){oe(this,e,t),h(this,e,n=>{this.h._attachBoolVectorListener(n)})}attachIntListener(e,t){ee(this,e,t),h(this,e,n=>{this.h._attachIntListener(n)})}attachIntVectorListener(e,t){oe(this,e,t),h(this,e,n=>{this.h._attachIntVectorListener(n)})}attachUintListener(e,t){ee(this,e,t),h(this,e,n=>{this.h._attachUintListener(n)})}attachUintVectorListener(e,t){oe(this,e,t),h(this,e,n=>{this.h._attachUintVectorListener(n)})}attachDoubleListener(e,t){ee(this,e,t),h(this,e,n=>{this.h._attachDoubleListener(n)})}attachDoubleVectorListener(e,t){oe(this,e,t),h(this,e,n=>{this.h._attachDoubleVectorListener(n)})}attachFloatListener(e,t){ee(this,e,t),h(this,e,n=>{this.h._attachFloatListener(n)})}attachFloatVectorListener(e,t){oe(this,e,t),h(this,e,n=>{this.h._attachFloatVectorListener(n)})}attachStringListener(e,t){ee(this,e,t),h(this,e,n=>{this.h._attachStringListener(n)})}attachStringVectorListener(e,t){oe(this,e,t),h(this,e,n=>{this.h._attachStringVectorListener(n)})}attachProtoListener(e,t,n){ee(this,e,t),h(this,e,r=>{this.h._attachProtoListener(r,n||!1)})}attachProtoVectorListener(e,t,n){oe(this,e,t),h(this,e,r=>{this.h._attachProtoVectorListener(r,n||!1)})}attachAudioListener(e,t,n){this.h._attachAudioListener||console.warn('Attempting to use attachAudioListener without support for output audio. Is build dep ":gl_graph_runner_audio_out" missing?'),ee(this,e,(r,o)=>{r=new Float32Array(r.buffer,r.byteOffset,r.length/4),t(r,o)}),h(this,e,r=>{this.h._attachAudioListener(r,n||!1)})}finishProcessing(){this.h._waitUntilIdle()}closeGraph(){this.h._closeGraph(),this.h.simpleListeners=void 0,this.h.emptyPacketListeners=void 0}},class extends Ln{ia(){this.h._registerModelResourcesGraphService()}});var Ln;async function xo(e,t){const n=await(async(r,o,i)=>{var s=M;if(r&&await Pn(r),!self.ModuleFactory||o&&(await Pn(o),!self.ModuleFactory))throw Error("ModuleFactory not set.");return self.Module&&i&&((r=self.Module).locateFile=i.locateFile,i.mainScriptUrlOrBlob&&(r.mainScriptUrlOrBlob=i.mainScriptUrlOrBlob)),i=await self.ModuleFactory(self.Module||i),self.ModuleFactory=self.Module=void 0,new s(i,null)})(e.wasmLoaderPath,e.assetLoaderPath,{locateFile:r=>r.endsWith(".wasm")?e.wasmBinaryPath.toString():e.assetBinaryPath&&r.endsWith(".data")?e.assetBinaryPath.toString():r});return await n.N(t),n}async function Nt(e,t){return xo(e,t)}function On(e){try{const t=e.J.length;if(t===1)throw Error(e.J[0].message);if(t>1)throw Error("Encountered multiple errors: "+e.J.map(n=>n.message).join(", "))}finally{e.J=[]}}function me(e,t){e.I=Math.max(e.I,t)}var jt=class{constructor(e){this.j=e,this.J=[],this.I=0,this.j.setAutoRenderToScreen(!1)}setGraph(e,t){this.j.attachErrorListener((n,r)=>{this.J.push(Error(r))}),this.j.ia(),this.j.setGraph(e,t),On(this)}finishProcessing(){this.j.finishProcessing(),On(this)}close(){this.j.closeGraph()}};jt.prototype.close=jt.prototype.close;var Ee=class extends A{constructor(e){super(e)}j(){return Te(j(this,2))??0}};function Nn(e,t){ne(e,1,t)}var Co=class extends A{constructor(e){super(e)}},Mr=[0,X,w,Dt,-1,z];function ko(e,t,n,r){if(e.data!==void 0){var o=new Uint8Array(e.data.buffer,t,n);return r===1&&function(i,s,a){i.i.push([s,a]),i.i.sort((l,c)=>l[0]-c[0]),s=0;for(const[l,c]of i.i){const u=c;(a=l)<=s&&(s=Math.max(s,a+u))}s===i.length&&(i.data=void 0)}(e,t,n),o}}Ee.prototype.l=He(Mr);class Ro{constructor(t){this.i=[],this.data=t,this.length=t.length}}function Lr(e,t){return new Bo(async()=>{const{value:n,done:r}=await e.read();return r?void 0:n},t)}async function Fn(e,t,n,r,o){if(o===2)return e.i=[],e.j=()=>Promise.resolve(void 0),setTimeout(()=>{e.l()},0),Promise.resolve(0);for(;e.size<n+r;){var i=await e.j();if(i===void 0)break;e.i.push(new Ro(i))}if(e.size<n+r)throw Error(`Data size is too small: ${e.size}, expected at least ${n+r}.`);i=t._malloc(r)>>>0;let s=0;for(let a=0;a<e.i.length;a++){const l=e.i[a];if(n>=l.length){n-=l.length;continue}const c=Math.min(r,l.length-n);if((n=ko(l,n,c,o))===void 0)throw Error("Data has already been released.");if(t.HEAPU8.set(n,i+s),n=0,s+=c,(r-=c)===0)break}if(r!==0)throw Error("Data not found.");return Promise.resolve(i)}var Bo=class{constructor(e,t){this.i=[],this.j=e,this.l=t}get size(){let e=0;for(let t=0;t<this.i.length;t++)e+=this.i[t].length;return e}};function Re(e){return typeof e=="object"&&e!=null&&"imageSource"in e}function Be(e){return typeof e=="object"&&e!=null&&"audioSource"in e}async function Un(e,t,n){e=new Nr(e,n);let r=0;for(t=t.getReader();;){const{value:o,done:i}=await t.read();if(i)break;e.set(o,r),r+=o.byteLength}if(n!==r)throw Or(e),Error(`File could not be fully loaded to memory, so was not retained. Loaded ${r}/${n} bytes before failure`);return e}function Or(e){if(e.i)try{e.h._free(e.j)}catch{}finally{e.i=!1}}var Nr=class{constructor(e,t){this.h=e,this.l=t,this.j=this.h._malloc(t)>>>0,this.o=this.h.HEAPU8,this.i=!!this.j}get offset(){if(!this.i)throw Error("WasmFileReference has been freed.");return this.j}get size(){if(!this.i)throw Error("WasmFileReference has been freed.");return this.l}set(e,t){this.o.set(e,this.j+(t??0))}},Fr=class extends A{constructor(e){super(e)}};Fr.prototype.j=He([0,R,2,U,w,S]);var Do=class extends A{constructor(e){super(e)}},jo=class extends A{constructor(e){super(e)}},$o=class extends A{constructor(e){super(e)}},Ur=class extends A{constructor(e){super(e)}},Ft=[0,w,-6,1,w,1,[0,S,X,-2],[0,S,Dt],X,-2,[0,S,-1,X,Dt,te,z,I,-1],1,S,w,z,-1,[0,X,w],S,-1,qe,w,-5,qe,-1,[0,z,qe],z,I,[0,z,-2],qe,[0,w],[0,w,-4],I,z,-2,I],xn=[0,R,-2],Cn=[0,[4,6],Ft,w,1,Po,U,Er,Qt,xn,z,[0,[0,w,-1,G,[0,w,[0,w,-1],-1,[0,X,-1],S],S,-2,w,-1],[0,w,-1,S],Ft,S,w,[0,w]],T,-3,[0,w,S],Ft,[0,xn,-2],Ae];Ur.prototype.j=He([0,R,8,[0,S,-6],1,w,1,w,[0,G,[0,R,To,-1,X],Cn,w],[0,w,S,-3],1,X,1,Cn,1,w,5,X,Ae,1,Mr,S,w]);var Go=class extends A{constructor(e){super(e)}},xr=class extends A{constructor(e){super(e)}},at=[2,4];xr.prototype.j=He([0,at,w,Er,w,B,[0,1,R]]);const zo=function(e){return class extends e{constructor(){super(...arguments),this.P=!1,this.F=this.H=0}M(){if(this.P)throw Error("Cannot process because LLM inference engine is currently loading or processing.");this.P=!0}L(){this.P=!1}async createLlmInferenceEngine(t,n){var r;this.M();try{const o=Lr(t,()=>{});await this.h.createLlmInferenceEngine(O(n,2)??512,((r=Ge(n,Ee,3))==null?void 0:r.j())??40,re(j(n,6))??!1??!1,O(n,7)??0,re(j(n,8))??!1??!1,(i,s,a)=>Fn(o,this.h,i,s,a))}finally{this.L()}}async aa(t,n){var r;this.M();try{await this.ka(t),await this.h.ccall("CreateLlmInferenceEngineConverted","void",["number","number","boolean"],[O(n,2)??512,((r=Ge(n,Ee,3))==null?void 0:r.j())??40,re(j(n,6))??!1??!1],{async:!0})}finally{this.L()}}V(){this.M();try{const t=this.h;t.ccall("DeleteLlmInferenceEngine","void",[],[],{async:!1}),this.H&&(t._FreeSession(this.H),this.F===this.H&&(this.F=0),this.H=0),this.F&&(t._FreeSession(this.F),this.F=0)}finally{this.L()}}async R(t,n,r){this.M();try{const o=[],i=this.h;i._userProgressListener=(f,p)=>{f&&o.push(f),r&&r(f,p)};const s=n.l(),a=s.length,l=this.h._malloc(a);this.h.HEAPU8.set(s,l);const c=t.some(Be),u=t.some(Re);i.ccallNum=i.ccall;const d=await i.ccallNum("MakeSessionForPredict","number",["number","number","boolean","boolean"],[l,a,u,c],{async:!0});n=[];for(const f of t)if(typeof f=="string")h(this,f,p=>{i._AddTextQueryChunk(d,p)});else if(Re(f)){const{image:p,width:y,height:E}=await this.da(f.imageSource),b=typeof OffscreenCanvas<"u"?new OffscreenCanvas(y,E):document.createElement("canvas");b.width=y,b.height=E;const N=b.getContext("2d");N.drawImage(p,0,0);const P=N.getImageData(0,0,y,E),C=this.h._malloc(P.width*P.height*4);this.h.HEAPU8.set(P.data,C),i._AddImageQueryChunk(d,C,P.width,P.height),n.push(C)}else{if(!Be(f))throw Error("Unsupported PromptPart type in query.");{const p=await fetch(f.audioSource);if(!p.ok)throw Error(`Audio fetch for ${f.audioSource} had error: ${p.status}`);const y=await p.arrayBuffer(),E=new Uint8Array(y),b=this.h._malloc(E.length);this.h.HEAPU8.set(E,b),i._AddAudioQueryChunk(d,b,E.length),n.push(b)}}await i.ccall("PredictSession","void",["number"],[d],{async:!0}),t=!0,u&&this.F===0&&(this.F=d,t=!1),c&&this.H===0&&(this.H=d,t=!1),t&&i._FreeSession(d);for(const f of n)this.h._free(f);return n.length=0,r&&r("",!0),this.h._free(l),i._userProgressListener=void 0,o.join("")}finally{this.L()}}S(t){this.M();let n=0,r="";for(const o of t)typeof o=="string"?r+=o:Re(o)?n+=260:Be(o)&&console.warn("sizeInTokens is not yet implemented for audio; audio tokens will not be counted");try{let o;return h(this,r,i=>{o=this.h._GetSizeInTokens(i)}),n+o}finally{this.L()}}async ka(t){t=await async function(n){const r=[];for(var o=0;;){const{done:i,value:s}=await n.read();if(i)break;r.push(s),o+=s.length}if(r.length===0)return new Uint8Array(0);if(r.length===1)return r[0];n=new Uint8Array(o),o=0;for(const i of r)n.set(i,o),o+=i.length;return n}(t);try{this.h.FS_unlink("llm.task")}catch{}this.h.FS_createDataFile("/","llm.task",t,!0,!1,!1)}async da(t){if(typeof t=="string"){const n=new Image;n.src=t,n.crossOrigin="Anonymous";try{await n.decode()}catch{throw Error(`Image from URL ${t} failed to load`)}return{image:n,width:n.naturalWidth,height:n.naturalHeight}}if(t instanceof HTMLImageElement){try{await t.decode()}catch{throw Error("Image from HTMLImageElement failed to load")}return{image:t,width:t.naturalWidth,height:t.naturalHeight}}return t instanceof HTMLVideoElement?{image:t,width:t.videoWidth,height:t.videoHeight}:t instanceof VideoFrame?{image:t,width:t.displayWidth,height:t.displayHeight}:{image:t,width:t.width,height:t.height}}}}(function(e){return class Cr extends e{static async ja(n,r){let o;r||(r=await Cr.X());const i=[];for(const s of(n==null?void 0:n.requiredFeatures)??[])r.features.has(s)?i.push(s):console.warn(`WebGPU feature ${s} is not supported.`);n={...n,requiredFeatures:i};try{o=await r.requestDevice(n)}catch(s){throw console.error("Unable to initialize WebGPU with the requested features."),s}return(n=o).adapterInfo||(n.adapterInfo=r.info),o}static async X(n){if(!(n=await navigator.gpu.requestAdapter(n)))throw Error("Unable to request adapter from navigator.gpu; Ensure WebGPU is enabled.");return n}ea(n){if(r)typeof HTMLCanvasElement<"u"&&r instanceof HTMLCanvasElement&&(r.id="canvas_webgpu");else var r=new OffscreenCanvas(1,1);r.getContext("webgpu").configure({device:n,format:navigator.gpu.getPreferredCanvasFormat()}),this.h.preinitializedWebGPUDevice=n}Z(){return this.h.ccall("closeGraph","void",[],[],{async:!0})}}}(function(e){return class extends e{addStreamingReaderToInputSidePacket(t,n){this.h.addStreamingReaderToInputSidePacket((r,o,i)=>Fn(t,this.h,r,o,i),n)}}}(function(e){return class extends e{Y(t,n){h(this,"lora_model_ref_in",r=>{this.h._addRawDataSpanToInputStream(t.offset,t.size,r,n)})}}}(class extends Uo{}))));class $t extends zo{}var Gt=class{constructor(e){this.j=e,this.i=kn,kn++}},kn=1;class Vo{constructor(){let t,n;this.promise=new Promise((r,o)=>{t=r,n=o}),this.resolve=t,this.reject=n}}function Rn(e){return e===1?1:e+e%2}async function Ke(){const e=await $t.X({powerPreference:"high-performance"});var t=e.limits.maxBufferSize,n=e.limits.maxStorageBufferBindingSize;return t<524550144&&console.warn(`This WebGPU device is unable to execute most LLM tasks, because the required maxBufferSize is usually at least 524550144, but your device only supports maxBufferSize of ${t}`),n<524550144&&console.warn(`The WebGPU device is unable to execute LLM tasks, because the required maxStorageBufferBindingSize is usually at least 524550144, but your device only supports maxStorageBufferBindingSize of ${n}`),t={requiredFeatures:["shader-f16"],requiredLimits:{maxStorageBufferBindingSize:n,maxBufferSize:t,maxStorageBuffersPerShaderStage:e.limits.maxStorageBuffersPerShaderStage}},e.features.has("subgroups")&&(console.warn("Experimental Chromium WGSL subgroup support detected. Enabling this feature in the inference engine."),n=["shader-f16","subgroups"],e.features.has("subgroups-f16")&&n.push("subgroups-f16"),t.requiredFeatures=n),$t.ja(t,e)}function we(e){if(e.D.length>0){const t=[...e.D];if(e.D.length=0,!e.o)throw t;e.o.reject(t),e.o=void 0}}function Ho(e){var r;const t=function(o){const i=new Tr;m(i,10,"text_in"),m(i,10,"token_cost_in"),m(i,10,"lora_model_id_to_apply_in"),m(i,10,"lora_model_ref_in"),m(i,10,"lora_model_id_to_load_in"),m(i,16,"streaming_reader"),m(i,15,"text_out"),m(i,15,"text_end"),m(i,15,"token_cost_out");var s=new K;F(s,2,"TokenizerInputBuildCalculator"),m(s,3,"PROMPT:text_in"),m(s,3,"LORA_ID:lora_model_id_to_apply_in"),m(s,4,"prompt"),Z(i,s),F(s=new K,2,"ModelDataCalculator"),m(s,6,"MODEL_DATA:__side_packet_1"),m(s,6,"MODEL_TYPE:model_type"),m(s,5,"READ_DATA_FN:streaming_reader"),m(s,3,"LORA_MODEL_SPAN:lora_model_ref_in"),m(s,3,"LORA_MODEL_ID:lora_model_id_to_load_in"),m(s,4,"LORA_DATA:lora_model_data"),Z(i,s),F(s=new K,2,"Gpt2UnicodeMappingCalculator"),m(s,5,"MODEL_TYPE:model_type"),m(s,6,"BYTES_TO_UNICODE_MAPPING:tokenizer_mapping"),Z(i,s),F(s=new fe,1,"type.googleapis.com/odml.infra.proto.TokenizerCalculatorOptions");var a=new xr,l=O(o.i,2);H(a,1,l),F(l=new Go,2,"spm_vocab_model"),l=dr(l);e:{Pe(a);var c=a.m,u=0|c[g];if(l==null){var d=un(c);if(hn(d,c,u)!==4)break e;d.set(at,0)}else{const f=un(d=c),p=hn(f,d,u);p!==4&&(p&&(u=W(d,u,p)),f.set(at,4))}W(c,u,4,l)}return l&&!V(l)&&Se(a.m),H(a,3,2),Lt(s,a.j()),F(a=new K,2,"TokenizerCalculator"),Fe(a,8,fe,s),m(a,5,"MODEL_DATA:__side_packet_1"),m(a,3,"PROMPT_AND_INPUT_OPTIONS:prompt"),m(a,5,"BYTES_TO_UNICODE_MAPPING:tokenizer_mapping"),m(a,6,"PROCESSOR_GETTER:__input_side_1"),m(a,4,"IDS_AND_INPUT_OPTIONS:__stream_0"),Z(i,a),F(s=new fe,1,"type.googleapis.com/odml.infra.proto.LlmGpuCalculatorOptions"),H(a=new Ur,12,3),F(a,1,"llm.tflite"),H(a,14,0),l=Rn(O(o.i,5)),H(a,22,l),l=Ge(o.i,Ee,3),ne(a,31,l),D(l=new Do,1,le(!0),!1),re(j(o.i,6))!=null&&(re(j(o.i,6))??!1)&&D(l,1,le(!1),!1),D(l,2,le(!0),!1),D(l,5,le(!0),!1),ne(a,10,l),l=ar(o.i,4,Te,Qr===void 0?2:4),hr(a,29,l),l=new $o,H(c=new jo,1,1),d=O(o.i,2),H(c,2,d),ne(l,1,c),ne(a,20,l),Lt(s,a.j()),F(a=new K,2,"LlmGpuCalculator"),Fe(a,8,fe,s),m(a,3,"IDS_AND_INPUT_OPTIONS:__stream_0"),m(a,3,"FINISH:finish"),m(a,3,"LORA_DATA:lora_model_data"),m(a,5,"MODEL_DATA:__side_packet_1"),m(a,4,"DECODED_IDS:__stream_3"),m(a,4,"OUTPUT_END:__stream_4"),F(s=new bn,1,"FINISH"),D(s,2,le(!0),!1),Fe(a,13,bn,s),Z(i,a),F(s=new K,2,"IsPacketPresentCalculator"),m(s,3,"__stream_4"),m(s,4,"text_end"),Z(i,s),F(s=new fe,1,"type.googleapis.com/odml.infra.proto.DetokenizerCalculatorOptions"),a=new Fr,o=Rn(O(o.i,5)),H(a,5,o),m(a,4,"<eos>"),m(a,4,"<|endoftext|>"),Lt(s,a.j()),F(o=new K,2,"DetokenizerCalculator"),Fe(o,8,fe,s),m(o,3,"IDS_AND_INPUT_OPTIONS:__stream_3"),m(o,5,"PROCESSOR_GETTER:__input_side_1"),m(o,5,"BYTES_TO_UNICODE_MAPPING:tokenizer_mapping"),m(o,5,"MODEL_DATA:__side_packet_1"),m(o,4,"FINISH_AND_INPUT_OPTIONS:finish"),m(o,4,"WORDS:text_out"),Z(i,o),F(o=new K,2,"TokenCostCalculator"),m(o,3,"PROMPT:token_cost_in"),m(o,5,"PROCESSOR_GETTER:__input_side_1"),m(o,5,"BYTES_TO_UNICODE_MAPPING:tokenizer_mapping"),m(o,4,"NUM_TOKENS:token_cost_out"),Z(i,o),i}(e);e.j.attachStringVectorListener("text_out",(o,i)=>{o=function(s,a){return s==null||s.length===0?[]:s.map(l=>(l=(l=l.replaceAll("▁"," ")).replaceAll("<0x0A>",`
`),a&&(l=l.trimStart()),l.split("\\[eod\\]",1)[0]))}(o,e.G.length===0),o.forEach((s,a)=>{a<O(e.i,5)&&e.G[a].push(s)}),e.v&&e.D.length===0&&(e.A?(o.length>O(e.i,5)&&o.pop(),e.v(o,!1)):e.v(o[0],!1)),me(e,i)}),e.j.attachEmptyPacketListener("text_out",o=>{me(e,o)}),e.j.attachBoolListener("text_end",(o,i)=>{me(e,i);try{we(e)}catch(s){throw e.l=!1,s}if(e.o&&(e.o.resolve(e.G.map(s=>s.join(""))),e.o=void 0),e.v)if(e.A){for(o=[],i=0;i<O(e.i,5);i++)o.push("");e.v(o,!0)}else e.v("",!0);e.l=!1,e.A=void 0}),e.j.attachEmptyPacketListener("text_end",o=>{e.l=!1,e.A=void 0,me(e,o),we(e),e.o&&(e.o.resolve(e.G.map(i=>i.join(""))),e.o=void 0)}),e.j.attachIntListener("token_cost_out",(o,i)=>{e.T=o,me(e,i)}),e.U&&e.j.addStreamingReaderToInputSidePacket(e.U,"streaming_reader");const n=t.j();return(r=e.C)==null||r.removeEventListener("uncapturederror",e.K),e.j.Z().then(()=>{var o;(o=e.C)==null||o.addEventListener("uncapturederror",e.K),e.D.length=0,e.setGraph(new Uint8Array(n),!0),e.finishProcessing()})}function Bn(e,t,n,r){if(e.v=typeof n=="function"?n:r,(r=(t=Array.isArray(t)?t:[t]).filter(o=>Re(o)).length)>0&&(rt(j(e.i,7))==null||O(e.i,7)<r))throw Error(`maxNumImages is set to ${rt(j(e.i,7))!=null?O(e.i,7):0}, but the query included ${r} images.`);if((r=t.filter(o=>Be(o)).length)>0&&(re(j(e.i,8))==null||!re(j(e.i,8))))throw Error(`supportAudio was not enabled, but the query included ${r} audio chunks.`);if(e.B){if(e.A&&O(e.i,5)>1)throw Error("Multi-response generation is not supported for converted LLM models (.task format) yet, nor is it supported for multimodality. Please use the .bin format without multimodality or request only one response.");if(n instanceof Gt)throw Error("LoRA is not supported for converted LLM models (.task format) yet, nor is it supported for multimodality. Please use the .bin format without multimodality to use LoRA.");return e.j.R(t,e.u,(o,i)=>{e.D.length===0&&e.v&&(e.A?e.v([o],i):e.v(o,i))}).then(o=>(we(e),[o]))}if(e.l)throw Error("Previous invocation or loading is still ongoing.");for(e.l=!0,e.G.length=0,r=0;r<O(e.i,5);r++)e.G[r]=[];if(r=e.I+1,e.j.addStringToStream(t.join(""),"text_in",r),n instanceof Gt){if(n.j!==e)throw e.l=!1,e.A=void 0,Error("The LoRA model was not loaded by this LLM Inference task.");e.j.addUintToStream(n.i,"lora_model_id_to_apply_in",r)}else e.j.addEmptyPacketToStream("lora_model_id_to_apply_in",r);return e.finishProcessing(),e.o=new Vo,e.o.promise}var M=class extends jt{constructor(e,t){if(super(new $t(e,t)),this.G=[],this.O=this.B=this.l=!1,this.D=[],this.K=n=>{if((n=n.error).message.match(/exceeds the max buffer size limit/))throw Error(`Failed to run this LLM model because it requires a buffer size that exceeds the maximum size your device supports, but you could try a smaller LLM model or different device.
WebGPU throws: "${n.message}"`);if(n.message.match(/is larger than the maximum storage buffer binding size/))throw Error(`Failed to run this LLM model because it requires a storage buffer binding size that exceeds the maximum size your device supports, but you could try a smaller LLM model or different device.
WebGPU throws: "${n.message}"`);this.D.push(n)},this.i=new Co,Nn(this.i,new En),this.u=new Ee,ne(this.i,3,this.u),Le(this.i,2,512),e=this.u,!Ie(2))throw je("enum");D(e,1,2,0),H(this.u,2,40),D(this.u,3,Tt(1),0),ue(this.u,5,kt(0)),D(this.u,4,Tt(.8),0),Le(this.i,5,1)}async N(e){var s,a,l,c,u,d,f;if(this.l)throw Error("Cannot set options while loading or processing.");if((s=e.baseOptions)!=null&&s.modelAssetPath&&((a=e.baseOptions)!=null&&a.modelAssetBuffer))throw Error("Cannot set both baseOptions.modelAssetPath and baseOptions.modelAssetBuffer");let t;const n=new Promise(p=>{t=p});if((l=e.baseOptions)!=null&&l.modelAssetPath){var r=await fetch(e.baseOptions.modelAssetPath.toString());if(!r.ok)throw Error(`Failed to fetch model: ${e.baseOptions.modelAssetPath} (${r.status})`);if(!r.body)throw Error(`Failed to fetch model: ${e.baseOptions.modelAssetPath} (no body)`);r=r.body.getReader()}else((c=e.baseOptions)==null?void 0:c.modelAssetBuffer)instanceof Uint8Array?r=function(p){return new ReadableStream({start(){},async pull(y){y.enqueue(p),y.close()}})}(e.baseOptions.modelAssetBuffer).getReader():((u=e.baseOptions)==null?void 0:u.modelAssetBuffer)instanceof ReadableStreamDefaultReader?(r=e.baseOptions.modelAssetBuffer,e.baseOptions.modelAssetBuffer=void 0):t();if(!r)throw Error("No model asset provided.");{const[p,y]=In(r);this.O=await async function(E){const b=[];let N;for(const[C,We]of No){const Br=C;var P=We;[E,N]=In(E),P=await P(N),await N.cancel(),P&&b.push(Br)}if(await E.cancel(),b.length===0)throw Error("No model format matched.");if(b.length===1)return b[0];throw Error(`Multiple model formats matched: ${b}`)}(y)===1;var o="maxNumImages"in e&&e.maxNumImages?e.maxNumImages:0;Le(this.i,7,o);var i="supportAudio"in e&&!!e.supportAudio;ue(this.i,8,le(i)),this.O||o>0||i?(this.B=!0,r=p):(this.B=!1,this.U=Lr(p,t))}if((f=(d=e.baseOptions)==null?void 0:d.gpuOptions)!=null&&f.device&&(this.C&&this.C.removeEventListener("uncapturederror",this.K),this.C=e.baseOptions.gpuOptions.device,this.j.ea(this.C),this.C.addEventListener("uncapturederror",this.K)),"maxTokens"in e&&Le(this.i,2,e.maxTokens??512),"topK"in e&&H(this.u,2,e.topK??40),"temperature"in e&&D(this.u,4,Tt(e.temperature??.8),0),"randomSeed"in e&&ue(this.u,5,kt(e.randomSeed??0)),"loraRanks"in e&&function(p,y){hr(p,4,y)}(this.i,e.loraRanks??[]),"numResponses"in e){if((o=e.numResponses??1)<1)throw Error("'numResponses' must be at least 1.");if(this.B&&o>1)throw Error("'numResponses > 1' is not supported for converted LLM models yet, and is also not supported with multimodality.");Le(this.i,5,o),i=Ge(this.i,Ee,3),o>1&&i&&(i.j()<=1||(j(i,4,Zn)??0)<=0)&&console.warn("To generate multiple responses, it is expected topK > 1 and temperature > 0; otherwise, all the generated responses may be the same.")}return"forceF32"in e&&e.forceF32!==void 0&&ue(this.i,6,le(e.forceF32)),this.B?(this.j.V(),this.O?this.j.aa(r,this.i).then(()=>{we(this)}):this.j.createLlmInferenceEngine(r,this.i).then(()=>{we(this)})):(this.l=!0,e=Ho(this).then(()=>{}),Promise.all([n,e]).then(()=>{this.l=!1,we(this)}))}get baseOptions(){return Ge(this.i,En,1)}set baseOptions(e){Nn(this.i,e)}get isIdle(){return!this.l&&!this.o}R(e,t,n){return O(this.i,5)>1&&console.warn("'numResponses' is set larger than 1 and this function only returns the first response, so we recommend either using 'generateResponses()' to obtain multiple responses, or else setting 'numResponses' to 1 for better performance."),this.A=!1,Bn(this,e,t,n).then(r=>r[0])}ca(e,t,n){return this.A=!0,Bn(this,e,t,n)}S(e){if(e=Array.isArray(e)?e:[e],this.B)return this.j.S(e);if(this.l)throw Error("Previous invocation or loading is still ongoing.");if(e.some(Re))throw Error("sizeInTokens requires maxNumImages > 0 for images.");if(e.some(Be))throw Error("sizeInTokens requires supportAudio for audio.");return e=e.join(""),this.l=!0,this.T=void 0,this.j.addStringToStream(e,"token_cost_in",this.I+1),this.finishProcessing(),this.l=!1,this.T}async ha(e){if(this.B)throw Error("LoRA is not supported for converted LLM models (.task format) yet, nor is it supported for multimodality. Please use the old format (.bin) without multimodality to use LoRA.");if(this.l)throw Error("Cannot load LoRA model while loading or processing.");if(this.l=!0,e instanceof Uint8Array){var t=new Nr(this.j.h,e.length);t.set(e),e=t}else e=e instanceof Blob?await async function(r,o){return Un(r,o.stream(),o.size)}(this.j.h,e):await async function(r,o){o=await fetch(o.toString());const i=Number(o.headers.get("content-length"));if(!o.body)throw Error("Response body is not available.");if(!i)throw Error("File size is 0.");return Un(r,o.body,i)}(this.j.h,e);t=new Gt(this);const n=this.I+1;return this.j.Y(e,n),this.j.addUintToStream(t.i,"lora_model_id_to_load_in",n),this.finishProcessing(),Or(e),me(this,n),this.l=!1,t}close(){var e;this.B&&this.j.V(),(e=this.C)==null||e.removeEventListener("uncapturederror",this.K),super.close()}};M.prototype.loadLoraModel=M.prototype.ha,M.prototype.sizeInTokens=M.prototype.S,M.prototype.generateResponses=M.prototype.ca,M.prototype.generateResponse=M.prototype.R,M.prototype.setOptions=M.prototype.N,M.createWebGpuDevice=Ke,M.createFromModelPath=async function(e,t){return Nt(e,t={baseOptions:{gpuOptions:{device:await Ke()},modelAssetPath:t}})},M.createFromModelBuffer=async function(e,t){return Nt(e,t={baseOptions:{gpuOptions:{device:await Ke()},modelAssetBuffer:t}})},M.createFromOptions=async function(e,t){var n,r,o;if(!((r=(n=t.baseOptions)==null?void 0:n.gpuOptions)!=null&&r.device)){const i=await Ke();t.baseOptions=t.baseOptions??{},t.baseOptions.gpuOptions=((o=t==null?void 0:t.baseOptions)==null?void 0:o.gpuOptions)??{},t.baseOptions.gpuOptions.device=i}return Nt(e,t)};const Je="models";function Xe(e){return`${e}.task`}const Wo=10*60*1e3,qo=1,Yo=1e3;class ie{static async checkModelExists(t){const n=Xe(t);console.log(`🔍 [opfs-manager] Checking OPFS file existence for ${t}...`);try{const s=await(await(await(await navigator.storage.getDirectory()).getDirectoryHandle(Je,{create:!1})).getFileHandle(n,{create:!1})).getFile(),a=s.size>0;return console.log(`🔍 [opfs-manager] Found model ${t} in OPFS: ${(s.size/1024/1024).toFixed(2)}MB`),a}catch(r){return r.name==="NotFoundError"?(console.log(`🔍 [opfs-manager] No model file found in OPFS: ${n}`),!1):(console.error(`❌ [opfs-manager] Failed to check OPFS model existence for ${t}:`,r),!1)}}static async getModelFileURL(t){try{const n=Xe(t);console.log(`🔗 [opfs-manager] Getting OPFS root directory for ${t}...`);const r=await navigator.storage.getDirectory();console.log("🔗 [opfs-manager] Getting models directory...");const o=await r.getDirectoryHandle(Je,{create:!1});console.log(`🔗 [opfs-manager] Getting file handle for: ${n}`);const i=await o.getFileHandle(n,{create:!1});console.log("🔗 [opfs-manager] Getting file object...");const s=await i.getFile();console.log(`🔗 [opfs-manager] File size for ${t}: ${(s.size/1024/1024).toFixed(2)}MB`);const a=URL.createObjectURL(s);return console.log(`🔗 [opfs-manager] Created file URL from OPFS for ${t}: ${a}`),a}catch(n){throw console.error(`❌ [opfs-manager] Failed to get OPFS file URL for ${t}:`,n),console.error("❌ [opfs-manager] Error details:",{name:n.name,message:n.message,stack:n.stack}),new Error(`OPFS file URL creation failed for ${t}: ${n.message}`)}}static async createFileWriter(t){try{const n=Xe(t);console.log(`📁 [opfs-manager] Creating OPFS file writer for ${t}...`);const i=await(await(await navigator.storage.getDirectory()).getDirectoryHandle(Je,{create:!0})).getFileHandle(n,{create:!0}),s=await i.createWritable();return console.log(`📄 [opfs-manager] Created OPFS writable stream: ${n}`),{writable:s,fileHandle:i}}catch(n){throw console.error(`❌ [opfs-manager] Failed to create OPFS writer for ${t}:`,n),new Error(`OPFS writer creation failed: ${n.message}`)}}static async deleteModel(t){const n=Xe(t);try{await(await(await navigator.storage.getDirectory()).getDirectoryHandle(Je,{create:!1})).removeEntry(n),console.log(`✅ [opfs-manager] OPFS model file deleted: ${n}`)}catch(r){if(r.name==="NotFoundError")console.log(`ℹ️ [opfs-manager] Model file not found in OPFS: ${n}`);else throw console.error(`❌ [opfs-manager] Failed to delete OPFS model ${t}:`,r),r}}static async downloadModelToOPFS(t,n,r,o,i){var a;console.log(`📥 [opfs-manager] Downloading model ${n.name} from Hugging Face...`);const s={modelId:t,progress:0,downloadedBytes:0,totalBytes:0,status:"downloading"};try{const l=n.modelPath;console.log(`🔗 [opfs-manager] Attempting to fetch: ${l}`);const c={"User-Agent":"Chrome Extension Crawler v4.18.1"};if(n.requiresToken){if(!r)throw new Error(`Model ${n.name} requires authentication token`);c.Authorization=`Bearer ${r}`,console.log("🔑 [opfs-manager] Using token:",`${r.substring(0,10)}...`)}else console.log("🔓 [opfs-manager] No authentication required for this model");const u=await fetch(l,{headers:c,signal:i});if(console.log("📡 [opfs-manager] Response status:",u.status,u.statusText),console.log("📡 [opfs-manager] Response headers:",Object.fromEntries(u.headers.entries())),!u.ok)throw new Error(`Failed to download model: ${u.status} ${u.statusText}`);console.log("📊 [opfs-manager] Starting model download to OPFS, this may take several minutes...");const d=(a=u.body)==null?void 0:a.getReader();if(!d)throw new Error("Response body is not readable");const f=parseInt(u.headers.get("content-length")||"0");console.log(`📦 [opfs-manager] Expected size: ${(f/1024/1024).toFixed(2)}MB`),s.totalBytes=f;const{writable:p}=await this.createFileWriter(t);let y=0,E=0,b=0;try{for(;;){const{done:N,value:P}=await d.read();if(N)break;await p.write(P),y+=P.length;const C=f>0?Math.floor(y/f*100):0,We=Date.now();s.downloadedBytes=y,s.progress=C,C-E>=qo&&(o==null||o(s),E=C),We-b>=Yo&&(console.log(`📊 [opfs-manager] Download progress: ${(y/1024/1024).toFixed(1)}MB / ${(f/1024/1024).toFixed(1)}MB (${C}%)`),b=We)}return await p.close(),console.log(`✅ [opfs-manager] Download complete to OPFS: ${(y/1024/1024).toFixed(2)}MB`),s.progress=100,s.status="completed",o==null||o(s),!0}catch(N){throw await p.abort(),s.status="error",s.error="Write failed",o==null||o(s),N}}catch(l){if(console.error("❌ [opfs-manager] Full error details:",{name:l.name,message:l.message,stack:l.stack}),s.status="error",s.error=l.message,o==null||o(s),l.name==="AbortError"){console.error("❌ [opfs-manager] Download aborted (timeout or user cancellation)");try{await this.deleteModel(t),console.log("🗑️ [opfs-manager] Incomplete download file cleaned up")}catch(c){console.warn("⚠️ [opfs-manager] Failed to cleanup incomplete file:",c)}}else if(l.message.includes("Failed to fetch")){const c=n.requiresToken?"Network error. Check your internet connection or Hugging Face token.":"Network error. Check your internet connection.";throw console.error(`❌ [opfs-manager] Network error during download of ${n.name}`),new Error(c)}else throw console.error(`❌ [opfs-manager] Failed to download ${n.name}:`,l),l;return!1}}}const pe=class pe{constructor(t,n){k(this,"llm",null);k(this,"status",{state:1});k(this,"currentModelId",et);k(this,"downloadProgress",null);k(this,"downloadAbortController",null);this.config=t,this.currentModelId=n||et,this.status.currentModelId=this.currentModelId}getLlm(){return this.llm}getCurrentModelId(){return this.currentModelId}isModelLoaded(){return this.status.state===3&&this.llm!==null}async checkWebGPUSupport(){try{if(!("gpu"in navigator)){console.warn("⚠️ [model-manager] WebGPU not supported in this browser");return}const t=await navigator.gpu.requestAdapter();if(!t){console.warn("⚠️ [model-manager] No WebGPU adapter found");return}const n=await t.requestDevice();console.log("🚀 [model-manager] WebGPU is supported and available"),console.log("🔧 [model-manager] GPU Adapter:",t),console.log("🔧 [model-manager] GPU Device:",n),console.log("✅ [model-manager] MediaPipe will use GPU acceleration if model supports it")}catch(t){console.warn("⚠️ [model-manager] WebGPU initialization failed:",t)}}async initialize(){if(this.status.state===3)return!0;if(this.status.state===2)return!1;try{this.status={...this.status,state:2};const t=Date.now();if(await this.checkWebGPUSupport(),!await ie.checkModelExists(this.currentModelId))return this.status={state:1,currentModelId:this.currentModelId,error:"Model not found in OPFS."},!1;const r=await ie.getModelFileURL(this.currentModelId);if(pe.genaiFileset)console.log("♻️ [model-manager] Reusing existing FilesetResolver");else{const s=chrome.runtime.getURL("wasm_files/");pe.genaiFileset=await ae.forGenAiTasks(s),console.log("🔧 [model-manager] Created new FilesetResolver")}this.llm=await M.createFromOptions(pe.genaiFileset,{baseOptions:{modelAssetPath:r},maxTokens:this.config.maxTokens,temperature:this.config.temperature,topK:this.config.topK,randomSeed:this.config.randomSeed});const o=Date.now()-t;this.status={state:3,loadTime:o,currentModelId:this.currentModelId};const i=ce[this.currentModelId];return console.log(`✅ [model-manager] Model loaded in ${o}ms`),console.log(`🤖 [model-manager] Active Model: ${(i==null?void 0:i.name)||this.currentModelId}`),console.log(`📋 [model-manager] Model ID: ${this.currentModelId}`),console.log(`📊 [model-manager] Model Size: ${(i==null?void 0:i.size)||"Unknown"}`),console.log("🔧 [model-manager] Model Config:",{maxTokens:this.config.maxTokens,temperature:this.config.temperature,topK:this.config.topK}),!0}catch(t){return this.status={state:1,error:t.message,currentModelId:this.currentModelId},console.error("❌ [model-manager] FAILED to initialize model:",t),!1}}async downloadAndCacheModel(t,n){const r=n||this.currentModelId,o=ce[r];if(!o)return!1;this.downloadProgress={modelId:r,progress:0,downloadedBytes:0,totalBytes:0,status:"downloading"},this.status={state:2,currentModelId:r},this.downloadAbortController=new AbortController;const i=setTimeout(()=>{var s;return(s=this.downloadAbortController)==null?void 0:s.abort()},Wo);try{const s=await ie.downloadModelToOPFS(r,o,t,a=>{this.downloadProgress=a,this.broadcastDownloadProgress()},this.downloadAbortController.signal);return clearTimeout(i),s&&(this.status={state:4,currentModelId:r}),this.downloadAbortController=null,s}catch(s){return clearTimeout(i),s.name==="AbortError"?(this.status={state:1,currentModelId:r,error:"Download cancelled"},await ie.deleteModel(r).catch(a=>console.warn(a))):this.status={state:1,currentModelId:r,error:s.message},this.downloadAbortController=null,!1}}cancelDownload(){var t;(t=this.downloadAbortController)==null||t.abort()}async deleteCachedModel(t){const n=t||this.currentModelId;await ie.deleteModel(n),n===this.currentModelId&&(this.llm&&(this.llm=null),this.status={state:1,currentModelId:this.currentModelId})}async getModelStatus(t){const n=t||this.currentModelId;if(this.status.state===1||this.status.currentModelId!==n){const o=await ie.checkModelExists(n)?4:1;if(this.currentModelId===n)this.status={...this.status,state:o,currentModelId:n};else return{state:o,currentModelId:n}}return{...this.status}}getDownloadProgress(){return this.downloadProgress}broadcastDownloadProgress(){this.downloadProgress&&chrome.runtime.sendMessage({action:"downloadProgress",progress:{...this.downloadProgress}}).catch(console.warn)}async switchModel(t){if(this.llm){console.log("🧹 [model-manager] Closing previous model instance");try{this.llm.close()}catch(n){console.warn("⚠️ [model-manager] Error closing previous model:",n)}this.llm=null}if(typeof window<"u"&&window.gc)try{window.gc(),console.log("🗑️ [model-manager] Forced garbage collection")}catch{}this.currentModelId=t,this.config=ce[t].defaultConfig,this.status={state:1,currentModelId:t},console.log(`🔄 [model-manager] Switched to model: ${t}`)}async getAllModelsStatus(){const t={};for(const n of Object.keys(ce))t[n]={exists:await ie.checkModelExists(n)};return t}};k(pe,"genaiFileset",null);let zt=pe;const Ko=[{command:"아이폰 15 찾아줘",action:"product_search",confidence:.95,reasoning:"제품명이 명확하고 검색 의도가 분명함"},{command:"저렴한 노트북 보여줘",action:"product_search",confidence:.9,reasoning:"가격 조건과 함께 제품 검색 요청"},{command:"이 제품 얼마예요",action:"price_comparison",confidence:.85,reasoning:"현재 제품의 가격 정보 요청"},{command:"아이폰 가격 비교해줘",action:"price_comparison",confidence:.9,reasoning:"특정 제품의 가격 비교 요청"},{command:"검색 버튼 클릭해줘",action:"simple_find",confidence:.95,reasoning:"UI 요소에 대한 명확한 조작 요청"},{command:"홈 버튼 눌러줘",action:"simple_find",confidence:.9,reasoning:"네비게이션 UI 요소 클릭 요청"},{command:"구매 버튼 찾아줘",action:"simple_find",confidence:.85,reasoning:"구매 관련 UI 요소 탐색 요청"},{command:"카테고리 선택해줘",action:"simple_find",confidence:.8,reasoning:"카테고리 UI 요소 조작 요청"},{command:"이거 장바구니에 있나 확인해줘",action:"simple_find",confidence:.8,reasoning:"장바구니 상태 확인을 위한 UI 탐색"},{command:"검색해서 최저가 찾아줘",action:"price_comparison",confidence:.9,reasoning:"검색과 가격 비교를 결합한 복합 요청"},{command:"이거 사고싶어",action:"purchase_flow",confidence:.85,reasoning:"구매 의사 표현으로 구매 프로세스 시작"},{command:"주문서 작성해줘",action:"purchase_flow",confidence:.95,reasoning:"구매 프로세스의 구체적 단계 요청"},{command:"결제 페이지로 이동해줘",action:"navigation",confidence:.9,reasoning:"결제 페이지로의 명확한 이동 요청"},{command:"어디에 있지",action:"simple_find",confidence:.7,reasoning:"불특정 요소의 위치 탐색 요청"}],Jo={baseExamples:Ko};function Xo(e){return e.map(n=>{const r=[];return r.push(`id:${n.id}`),r.push(`t:${n.type}`),n.text&&r.push(`txt:"${n.text.substring(0,50)}"`),n.label&&r.push(`l:"${n.label.substring(0,50)}"`),n.isClickable&&r.push("clk:t"),n.isInputtable&&r.push("inpt:t"),`{${r.join(",")}}`}).join(" ")}const lt={AGENT_PLANNER:{name:"Agent Planner",description:"사용자 명령과 현재 페이지의 DOM 요소를 바탕으로 행동 계획을 JSON 시퀀스로 생성합니다.",template:(e,t,n,r)=>{const o=Xo(n);return`<start_of_turn>user
You are a helpful AI agent controlling a web browser. Your goal is to create a plan to fulfill the user's command based on the current state of the web page.

**CURRENT MODE: ${r.toUpperCase()}**
- In 'navigate' mode, your primary goal is to find and click elements to navigate the page.
- In 'search' mode, your primary goal is to input text into search bars and submit.

**CONTEXT: INTERACTABLE PAGE ELEMENTS**
Here are the interactable elements currently on the page. Each element has an 'id' you MUST use to target it.

${o}

**TASK**
Based on the user's command and the current mode, create a JSON object representing a sequence of actions.
The valid actions are: "CLICK", "INPUT", "NAVIGATE", "SCROLL".

**CRITICAL RULES (MUST FOLLOW OR SYSTEM WILL FAIL):**
1. Navigation commands (back, forward, refresh) MUST ALWAYS use "NAVIGATE" action, NOT DOM elements.
2. INPUT action is FORBIDDEN unless the element has "inpt:t" property. NEVER use INPUT on elements without "inpt:t".
3. CLICK action should be used for elements with "clk:t" property (buttons, links).
4. If search is requested but NO elements have "inpt:t" property, return EMPTY plan: { "plan": [] }.
5. VALIDATE: Before creating INPUT action, confirm the element has "inpt:t" property in the data above.

- For "CLICK", specify the target 'id' of a clickable element (must have "clk:t").
- For "INPUT", specify the target 'id' of an input field (must have "inpt:t") and the 'value' to type.
- For "NAVIGATE", specify 'type' for browser actions ("back", "forward", "refresh") - NO ID NEEDED.
- For "SCROLL", specify 'direction' ("up" or "down") and optionally 'target' id for specific element scrolling.
- The output MUST be a JSON object with a "plan" key, which is an array of action steps.

**EXAMPLES**
User Command: "Search for smartphones" (assuming elements {id:12,inpt:t} and {id:13,clk:t} exist)
Your Plan: { "plan": [{ "action": "INPUT", "id": 12, "value": "smartphones" }, { "action": "CLICK", "id": 13 }] }

User Command: "Search for smartphones" (when NO element has "inpt:t")
Your Plan: { "plan": [] }

User Command: "뒤로 가기" or "뒤로" or "back"
Your Plan: { "plan": [{ "action": "NAVIGATE", "type": "back" }] }

User Command: "앞으로 가기" or "앞으로" or "forward"
Your Plan: { "plan": [{ "action": "NAVIGATE", "type": "forward" }] }

User Command: "새로고침" or "refresh" or "리로드"
Your Plan: { "plan": [{ "action": "NAVIGATE", "type": "refresh" }] }

User Command: "아래로 스크롤해줘"
Your Plan: { "plan": [{ "action": "SCROLL", "direction": "down" }] }

**YOUR TURN**
User Command: "${e}"
Your Plan:
<end_of_turn>
<start_of_turn>model`}},CHAT_ASSISTANT:{name:"Chat Assistant",description:"사용자와 자연스러운 대화를 나누는 채팅 어시스턴트입니다. 명령 수행이 아닌 대화만 진행합니다.",template:(e,t,n,r)=>`<start_of_turn>user
당신은 친근하고 도움이 되는 AI 채팅 어시스턴트입니다. 사용자와 자연스러운 대화를 나누세요.

**중요 규칙:**
1. 웹 페이지 조작이나 명령 수행을 하지 마세요
2. JSON 형식이 아닌 자연스러운 텍스트로 답변하세요
3. 친근하고 도움이 되는 톤으로 대화하세요
4. 질문에 대해 정확하고 유용한 정보를 제공하세요

사용자 메시지: "${e}"

당신의 답변:
<end_of_turn>
<start_of_turn>model`}};lt.AGENT_PLANNER;function Dn(e){return lt[e]}function Qo(){return Jo.baseExamples}class jn{static parseChatResponse(t){try{return console.log("💬 [ai-response-parser] Chat response:",t),t.trim()||"죄송합니다. 응답을 생성할 수 없습니다."}catch(n){return console.error("❌ [ai-parser] Failed to process chat response:",n),"죄송합니다. 응답 처리 중 오류가 발생했습니다."}}static parseAIResponse(t,n,r){try{if(console.log("🔍 [ai-response-parser] Raw AI response:",t),console.log("🔍 [ai-response-parser] Mode:",r),r==="chat"){const l=t.trim();return{plan:[],reasoning:l,rawResponse:l}}const o=t.indexOf("{"),i=t.lastIndexOf("}");if(o===-1||i===-1||i<o)return console.warn("⚠️ [ai-response-parser] No valid JSON object found in response."),{plan:[],reasoning:"Fallback: No JSON object found in AI response.",rawResponse:t};let s=t.substring(o,i+1);s=s.replace(/\n/g,`
`).replace(/'/g,"'").replace(/"/g,'"').replace(/&/g,"&").replace(/\r/g,"\r	").replace(/\t/g,"	").replace(/\b/g,"\b").replace(/\f/g,"\f"),s=s.replace(/[\u0000-\u0019]+/g,""),console.log("🔧 [ai-response-parser] Sanitized JSON string:",s);const a=JSON.parse(s);return a.plan&&Array.isArray(a.plan)?{plan:a.plan,reasoning:a.reasoning||"Plan generated by AI.",rawResponse:t}:(console.warn('⚠️ [ai-parser] Parsed JSON does not contain a valid "plan" array.'),{plan:[],reasoning:"Fallback: Parsed JSON has no valid plan.",rawResponse:t})}catch(o){return console.error("❌ [ai-parser] Failed to parse AI response JSON:",o),console.error("❌ [ai-parser] Original response was:",t),{plan:[],reasoning:`Fallback: JSON parsing failed: ${o.message}`,rawResponse:t}}}}class Zo{constructor(t,n){k(this,"isAnalyzing",!1);k(this,"analysisQueue",[]);k(this,"currentPromptName","AGENT_PLANNER");this.llm=t,this.aiController=n}setLlm(t){this.llm=t}async analyzeIntent(t,n,r){return new Promise((o,i)=>{this.analysisQueue.push({voiceInput:t,crawledItems:n,mode:r,resolve:o,reject:i}),this.processAnalysisQueue()})}async analyzeChat(t){if(!this.aiController.isReadyForInference())throw new Error("AI model is not ready for inference");try{const n=this.currentPromptName;this.setPromptTemplate("CHAT_ASSISTANT");const r=await this.buildChatPrompt(t),o=await this.llm.generateResponse(r),i=jn.parseChatResponse(o);return this.setPromptTemplate(n),i}catch(n){throw console.error("❌ [inference-engine] Chat analysis failed:",n),n}}async buildChatPrompt(t){return Dn("CHAT_ASSISTANT").template(t,[],[],"chat")}async processAnalysisQueue(){if(!this.aiController.isReadyForInference()||this.isAnalyzing||this.analysisQueue.length===0)return;this.isAnalyzing=!0;const{voiceInput:t,crawledItems:n,mode:r,resolve:o,reject:i}=this.analysisQueue.shift();try{const s=await this.buildAnalysisPrompt(t,n,r),a=performance.now(),l=await this.llm.generateResponse(s),u=performance.now()-a;console.log(`🚀 [inference-engine] AI inference took ${u.toFixed(2)}ms`),console.log(`📊 [inference-engine] Mode: ${r}, Input length: ${t.length}`),console.log(`🤖 [inference-engine] Current Model: ${this.aiController.getCurrentModelId()}`);const d=jn.parseAIResponse(l,t,r);o(d)}catch(s){console.error("❌ [inference-engine] AI analysis failed:",s),i(s)}finally{this.isAnalyzing=!1,this.processAnalysisQueue()}}async buildAnalysisPrompt(t,n,r){const o=r==="chat"?"CHAT_ASSISTANT":this.currentPromptName,i=Dn(o),s=Qo();return i.template(t,s,n,r)}setPromptTemplate(t){this.currentPromptName=t}getCurrentPrompt(){return lt[this.currentPromptName].name}getAvailablePrompts(){return Object.entries(lt).map(([t,n])=>({name:t,description:n.description}))}}class kr{constructor(t={},n){k(this,"modelManager");k(this,"inferenceEngine");k(this,"isInitialized",!1);const r=n||et,i={...ce[r].defaultConfig,...t};this.modelManager=new zt(i,r),this.inferenceEngine=new Zo(null,this)}async initialize(){this.isInitialized=!1;const t=await this.modelManager.initialize();return t&&(this.inferenceEngine.setLlm(this.modelManager.getLlm()),this.isInitialized=!0),t}isReadyForInference(){return this.isInitialized}async downloadAndCacheModel(t,n){return this.isInitialized=!1,this.modelManager.downloadAndCacheModel(t,n)}async downloadAndCacheModelAsPath(t,n){return this.downloadAndCacheModel(t,n)}cancelDownload(){this.modelManager.cancelDownload()}async deleteCachedModel(t){await this.modelManager.deleteCachedModel(t)}async getModelStatus(t){return this.modelManager.getModelStatus(t)}getDownloadProgress(){return this.modelManager.getDownloadProgress()}async analyzeIntent(t,n,r){return this.inferenceEngine.analyzeIntent(t,n,r)}async analyzeChat(t){return this.inferenceEngine.analyzeChat(t)}setPromptTemplate(t){this.inferenceEngine.setPromptTemplate(t)}getCurrentPrompt(){return this.inferenceEngine.getCurrentPrompt()}getAvailablePrompts(){return this.inferenceEngine.getAvailablePrompts()}getAvailableModels(){return ce}getCurrentModelId(){return this.modelManager.getCurrentModelId()}isModelLoaded(){return this.modelManager.isModelLoaded()}async switchModel(t,n,r=!1){this.isInitialized=!1;const o=ce[t];if(!o)return!1;if(console.log(`🔄 [ai-controller] Switching from ${this.getCurrentModelId()} to ${t}`),await this.modelManager.switchModel(t),this.inferenceEngine.setLlm(null),Rr(t),await this.modelManager.getModelStatus(t).then(a=>a.state===4))return r?this.initialize():!0;if(o.requiresToken&&!n)return!1;const s=await this.downloadAndCacheModel(n||"",t);return s&&r?this.initialize():s}async getAllModelsStatus(){return this.modelManager.getAllModelsStatus()}}let $=null,Ze=et;function ei(e){const t=e||Ze;return console.log(`🔍 [getAIController] Called with modelId: ${e}, currentActiveModelId: ${Ze}, targetModelId: ${t}`),console.log(`🔍 [getAIController] Existing instance model: ${($==null?void 0:$.getCurrentModelId())||"none"}`),!$||$.getCurrentModelId()!==t?(console.log(`🔄 [getAIController] Creating new controller for model: ${t}`),console.log(`📊 [getAIController] Previous: ${($==null?void 0:$.getCurrentModelId())||"none"} → New: ${t}`),$=new kr({},t),Ze=t):console.log(`✅ [getAIController] Using existing controller for model: ${t}`),$}function Rr(e){console.log(`🎯 [setCurrentActiveModel] Setting active model to: ${e}`),Ze=e,$=null}const ni=Object.freeze(Object.defineProperty({__proto__:null,AIController:kr,getAIController:ei,setCurrentActiveModel:Rr},Symbol.toStringTag,{value:"Module"}));export{ce as A,ni as a,ei as g};
