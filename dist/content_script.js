var F=Object.defineProperty;var V=(e,t,n)=>t in e?F(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var A=(e,t,n)=>V(e,typeof t!="symbol"?t+"":t,n);function k(e){const t=e.getBoundingClientRect(),n=getComputedStyle(e);return t.width>0&&t.height>0&&n.visibility!=="hidden"&&n.opacity!=="0"}function G(e){return e.closest("header")?"header":e.closest("footer")?"footer":e.closest("nav")?"nav":e.closest("aside")?"sidebar":e.closest("main")?"main":e.closest("article")?"article":e.closest("section")?"section":"block"}function O(e){const t=e.getBoundingClientRect();return{top:Math.round(t.top),left:Math.round(t.left),width:Math.round(t.width),height:Math.round(t.height)}}function H(e){const t=e.tagName.toLowerCase(),n=e.getAttribute("role"),o=t==="button"||n==="button",r=t==="a"&&e.hasAttribute("href"),i=e.disabled||!1,s={isDisabled:i,isChecked:e.checked,isFocused:document.activeElement===e},a=!i&&(o||r),l=!i&&(t==="input"||t==="textarea"||e.contentEditable==="true"||n==="textbox"||n==="searchbox"||e.hasAttribute("contenteditable")||e.classList.contains("search_input_box")||e.classList.contains("search-box")||e.classList.contains("search_input")||!!e.querySelector('input[type="search"], input[type="text"], input:not([type])'));return{state:s,isClickable:a,isInputtable:l}}function C(){return{visited:0,nextElementId:0,nextItemId:0,elIdMap:new WeakMap,elMeta:new Map,items:[],seenTextGlobal:new Set}}function W(e){const t=[];return e.items.forEach(n=>{if(n.hidden){const o=document.querySelector(`[data-crawler-id="${n.ownerId}"]`);o&&k(o)&&(n.hidden=!1,n.rect=O(o),t.push(n))}}),t}const N=8e3,B=600,z=new Set(["p","h1","h2","h3","h4","h5","h6","span","a","li","div","section","header","footer","main","aside","article","img","button","input","textarea","select"]),R=new Set(["script","style","noscript","link","meta","template","svg","canvas","object"]),U=new Set(["iframe"]);function c(e){return(e||"").replace(/[\u200B-\u200D\uFEFF]/g,"").replace(/\s+/g," ").trim().slice(0,B)}class X{constructor(){A(this,"iframeOffsets",new Map)}registerIframe(t){const n=t.getBoundingClientRect(),o={x:n.left+window.scrollX,y:n.top+window.scrollY};this.iframeOffsets.set(t,o),console.log("ðŸ“ [coordinate] Registered iframe offset:",o)}transformIframeElementCoordinates(t,n){const o=t.getBoundingClientRect(),r=this.iframeOffsets.get(n);if(!r)return console.warn("âš ï¸ [coordinate] Iframe offset not registered, using element coordinates as-is"),{top:o.top,left:o.left,width:o.width,height:o.height};const i={top:o.top+r.y,left:o.left+r.x,width:o.width,height:o.height};return console.log("ðŸ“ [coordinate] Transformed coordinates:",{original:{top:o.top,left:o.left},iframeOffset:r,transformed:{top:i.top,left:i.left}}),i}needsTransformation(t){let n=t;for(;n&&n!==document.body;){if(n.ownerDocument!==document)return!0;n=n.parentElement}return!1}findParentIframe(t){const n=t.ownerDocument;if(n===document)return null;const o=document.querySelectorAll("iframe");for(const r of o)try{if(r.contentDocument===n)return r}catch{continue}return null}clear(){this.iframeOffsets.clear(),console.log("ðŸ§¹ [coordinate] Cleared iframe offsets")}}const b=new X;function v(e,t,n=null,o=!1,r=!1){if(!(e instanceof HTMLElement)||t.elIdMap.has(e)||(t.visited++,t.visited>N))return;const i=e.tagName.toLowerCase();if(R.has(i)||getComputedStyle(e).display==="none")return;const s=t.nextElementId++;t.elIdMap.set(e,s),e.setAttribute("data-crawler-id",s.toString());let a=O(e);if(b.needsTransformation(e)){const w=b.findParentIframe(e);w&&(a=b.transformIframeElementCoordinates(e,w))}const{state:l,isClickable:u,isInputtable:f}=H(e),y={tag:i,role:G(e),rect:a,parentId:n};if(U.has(i))return;t.elMeta.set(s,y);const P=z.has(i),E=i==="a",I=i==="button"||y.role==="button";if(P){const w=k(e),g={id:s,ownerId:s,parentId:n,tag:i,role:y.role,rect:y.rect,hidden:!w,state:l,isClickable:u,isInputtable:f};if(i==="img"&&t.items.push({...g,type:"image",alt:c(e.getAttribute("alt")),title:c(e.getAttribute("title")),src:e.getAttribute("src")||""}),E&&t.items.push({...g,type:"link",href:e.getAttribute("href")||"",text:c(e.textContent)}),I&&t.items.push({...g,type:"button",label:c(e.getAttribute("aria-label")||e.textContent||"")||"(no label)"}),i==="input"){const d=e;t.items.push({...g,type:"input",inputType:d.type||"text",placeholder:c(d.placeholder||""),label:c(e.getAttribute("aria-label")||d.name||"")||c(d.placeholder||"")||`[${d.type} input]`})}if(i==="textarea"){const d=e;t.items.push({...g,type:"textarea",placeholder:c(d.placeholder||""),label:c(e.getAttribute("aria-label")||d.name||"")||c(d.placeholder||"")||"[textarea]"})}if(i==="select"&&t.items.push({...g,type:"select",label:c(e.getAttribute("aria-label")||e.name||"")||"[select]"}),!E&&!o&&!I&&!r){for(const d of e.childNodes)if(d.nodeType===Node.TEXT_NODE){const S=c(d.nodeValue||"");S&&t.items.push({...g,type:"text",text:S})}}}for(const w of e.children){if(t.visited>N)break;v(w,t,s,E||o,I||r)}}function M(e){const t=[],n=new Set;for(const o of e){if(o.hidden){t.push(o);continue}const r=`${o.type}|${o.text||o.label||o.href}|${Math.round(o.rect.left/10)}|${Math.round(o.rect.top/10)}`;n.has(r)||(t.push(o),n.add(r))}return t}async function Y(e){const t=document.querySelectorAll("iframe");if(t.length===0){console.log("ðŸ“± [naver] No iframes found");return}console.log(`ðŸ“± [naver] Found ${t.length} iframe(s), processing...`);for(const n of t)await K(n,e)}async function K(e,t){const n=e.src;if(!Q(n))return;if(console.log(`ðŸ” [naver] Processing iframe: ${n}`),!await j(e)){console.log("â° [naver] Iframe loading timeout"),L(e,t);return}b.registerIframe(e);const r=await J(e);if(r&&r.body){console.log("âœ… [naver] Direct iframe access successful");const i=t.items.length;v(r.body,t);const s=t.items.length-i;console.log(`ðŸ“Š [naver] Added ${s} items from iframe`)}else console.log("ðŸš« [naver] Cannot access iframe content (CORS)"),L(e,t)}async function j(e){return e.contentDocument?!0:new Promise(t=>{const n=setTimeout(()=>t(!1),3e3);e.addEventListener("load",()=>{clearTimeout(n),t(!0)},{once:!0})})}async function J(e){try{if(e.contentDocument&&e.contentDocument.body)return e.contentDocument;if(e.contentWindow&&e.contentWindow.document)return e.contentWindow.document;if(await new Promise(t=>setTimeout(t,1e3)),e.contentDocument&&e.contentDocument.body)return e.contentDocument}catch(t){console.log("ðŸš« [naver] CORS blocked iframe access:",t)}return null}function L(e,t){const n=t.nextElementId++;t.elIdMap.set(e,n);const o=e.getBoundingClientRect();t.items.push({id:t.nextItemId++,ownerId:n,parentId:null,tag:"iframe",role:"frame",rect:{top:o.top,left:o.left,width:o.width,height:o.height},type:"iframe",text:`ë„¤ì´ë²„ ë¸”ë¡œê·¸ ì»¨í…ì¸ : ${e.src}`,src:e.src,hidden:!1}),console.log("ðŸ“ [naver] Added iframe as fallback item")}function Q(e){return e?e.includes("PostList.naver")||e.includes("PostView.naver")||e.includes("blog.naver.com")||e.startsWith("/Post"):!1}let p=null;async function Z(){const e=performance.now();b.clear();const t=C();p=t,v(document.body,t,null),window.location.hostname.includes("blog.naver.com")&&await Y(t);const n=M(t.items);t.items=n,n.sort((s,a)=>s.hidden!==a.hidden?s.hidden?1:-1:s.rect.top-a.rect.top||s.rect.left-a.rect.left);const o=Number((performance.now()-e).toFixed(1)),r=n.filter(s=>!s.hidden).length,i=n.filter(s=>s.hidden).length;return{url:location.href,userAgent:navigator.userAgent,visited:t.visited,elapsedMs:o,items:n,stats:{total:n.length,visible:r,hidden:i}}}function q(e){const t=performance.now();p||(p=C());const n=p.items,o=[],r={...p,items:o};e.forEach(u=>{u instanceof HTMLElement&&v(u,r,null)}),p.items=n;const i=W(p),s=[...o,...i],a=M(s),l=Number((performance.now()-t).toFixed(1));return a.length>0&&console.log(`âœ… Dynamic analysis: ${a.length} items (${o.length} new, ${i.length} revealed) in ${l}ms`),a}const $={analyze:Z,analyzeElements:q};function ee(e){const t=new Set,n=new Set,o=new Set;e.forEach(a=>{a.type==="childList"?(a.removedNodes.forEach(l=>{l instanceof HTMLElement&&t.add(l)}),a.addedNodes.forEach(l=>{l instanceof HTMLElement&&n.add(l)})):a.type==="attributes"&&["class","style","id"].includes(a.attributeName||"")&&a.target instanceof HTMLElement&&a.target.hasAttribute("data-crawler-id")&&o.add(a.target)});const r=[...t].filter(a=>n.has(a)&&a.hasAttribute("data-crawler-id")),i=[];o.forEach(a=>{i.push(a)});const s=[...r,...i];return s.length>0&&console.log(`ðŸš€ Portal movement detected: ${r.length} direct moves, ${i.length} position changes`),s}function te(e){const t=[];return e.forEach(n=>{if(n.type==="attributes"&&n.target instanceof HTMLElement){const o=n.target,r=n.attributeName;if(r==="class"||r==="id"){const i=o.getAttribute(r)||"",s=n.oldValue||"";(i.includes("expanded")&&!s.includes("expanded")||i.includes("open")&&!s.includes("open")||i.includes("show")&&!s.includes("show")||i.includes("visible")&&!s.includes("visible")||r==="id"&&i!==s&&(i.includes("pb")||s.includes("pb")))&&(console.log(`ðŸŽ¯ Portal navigation detected: ${r} changed from "${s}" to "${i}"`),t.push(o),o.querySelectorAll("[data-crawler-id]").forEach(u=>{u instanceof HTMLElement&&t.push(u)}))}}}),[...new Set(t)]}function D(e){const t=C(),o=["a","button","input","textarea","select"].map(i=>`${i}:not([data-crawler-id])`).join(", "),r=e.querySelectorAll(o);return r.forEach(i=>{ne(i,t)}),r.length>0&&console.log(`ðŸ” Fast-scanned ${r.length} target elements in changed container`),t.items}function ne(e,t){if(t.elIdMap.has(e))return;const n=t.nextElementId++;t.elIdMap.set(e,n),e.setAttribute("data-crawler-id",n.toString());const o=e.tagName.toLowerCase(),r={tag:o,role:e.getAttribute("role")||"",rect:e.getBoundingClientRect(),parentId:null};t.elMeta.set(n,r);const{state:i,isClickable:s,isInputtable:a}=H(e);if(["a","button","input","textarea","select"].includes(o)){const l=getComputedStyle(e).display!=="none",u={id:n,ownerId:n,parentId:null,tag:o,role:r.role,rect:r.rect,hidden:!l,state:i,isClickable:s,isInputtable:a};if(o==="a")t.items.push({...u,type:"link",href:e.getAttribute("href")||"",text:c(e.textContent)});else if(o==="button")t.items.push({...u,type:"button",label:c(e.getAttribute("aria-label")||e.textContent||"")||"(no label)"});else if(o==="input"){const f=e;t.items.push({...u,type:"input",inputType:f.type||"text",placeholder:c(f.placeholder||""),label:c(e.getAttribute("aria-label")||f.name||"")||c(f.placeholder||"")||`[${f.type} input]`})}else if(o==="textarea"){const f=e;t.items.push({...u,type:"textarea",placeholder:c(f.placeholder||""),label:c(e.getAttribute("aria-label")||f.name||"")||c(f.placeholder||"")||"[textarea]"})}else o==="select"&&t.items.push({...u,type:"select",label:c(e.getAttribute("aria-label")||e.name||"")||"[select]"})}}function oe(e,t){const n=performance.now(),o=re(e),r=ie(o,t),i=M(r);return se(o,i,n),i}function re(e){const t=ee(e),n=te(e),o=[];return e.forEach(r=>{r.type==="childList"?r.addedNodes.forEach(i=>{i instanceof HTMLElement&&!t.includes(i)&&!n.includes(i)&&o.push(i)}):r.type==="attributes"&&r.target instanceof HTMLElement&&o.push(r.target)}),{movedElements:t,portalChangedElements:n,regularElements:[...new Set(o)]}}function ie(e,t){const n=[];if(e.movedElements.length>0&&e.movedElements.forEach(o=>{const r=D(o);n.push(...r)}),e.portalChangedElements.length>0&&(e.portalChangedElements.forEach(o=>{const r=D(o);n.push(...r)}),console.log(`ðŸŽ¯ Analyzed ${e.portalChangedElements.length} portal navigation elements`)),e.regularElements.length>0){console.log(`ðŸ”„ DOM changed, analyzing ${e.regularElements.length} new/updated elements.`);const o=t.analyzeElements(e.regularElements);n.push(...o)}return n}function se(e,t,n){const o=e.movedElements.length+e.portalChangedElements.length,r=(performance.now()-n).toFixed(1);t.length>0?console.log(`âœ… Found ${t.length} new items in ${r}ms (${o>0?`including ${o} portal elements`:"regular changes"})`):console.log(`ðŸ“ No new crawlable items found (${r}ms).`)}let m=null;function ae(e,t){m&&T(),m={observer:new MutationObserver(n=>{n.some(r=>r.type==="childList"&&r.addedNodes.length>0||r.type==="attributes")&&m&&ce(m,n)}),observerTimeout:null,crawler:e,onNewItemsFound:t},m.observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["class","style","hidden","aria-hidden","id"]}),console.log("ðŸ” Dynamic element observer started with attribute monitoring.")}function T(){m&&(m.observer.disconnect(),m.observerTimeout&&clearTimeout(m.observerTimeout),m=null,console.log("ðŸ›‘ Dynamic element observer stopped"))}function ce(e,t){e.observerTimeout&&clearTimeout(e.observerTimeout),e.observerTimeout=window.setTimeout(()=>{const n=oe(t,e.crawler);n.length>0&&e.onNewItemsFound(n),e.observerTimeout=null},300)}const le=2500,_={outline:"3px solid #007AFF",boxShadow:"0 0 15px rgba(0, 122, 255, 0.5)"},ue={behavior:"smooth",block:"center"};function de(e){e.scrollIntoView(ue),e.style.outline=_.outline,e.style.boxShadow=_.boxShadow}function fe(e){e.style.outline="",e.style.boxShadow=""}let h={highlightedElement:null,highlightTimer:null};function x(){h.highlightTimer&&(clearTimeout(h.highlightTimer),h.highlightTimer=null),h.highlightedElement&&(fe(h.highlightedElement),h.highlightedElement=null)}function me(e,t=le){x(),de(e),h.highlightedElement=e,h.highlightTimer=window.setTimeout(()=>{x()},t)}chrome.runtime.onMessage.addListener((e,t,n)=>{try{switch(e.action){case"execute_click":{const o=document.querySelector(`[data-crawler-id="${e.crawlerId}"]`);return o?(console.log(`ðŸ–±ï¸ [content] Executing CLICK on ID: ${e.crawlerId}`,o),o.click(),n({success:!0})):n({success:!1,error:"Element not found in this frame"}),!0}case"execute_input":{const o=document.querySelector(`[data-crawler-id="${e.crawlerId}"]`);return o?(console.log(`âŒ¨ï¸ [content] Executing INPUT on ID: ${e.crawlerId} with value: "${e.value}"`,o),o.value=e.value,o.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),n({success:!0})):n({success:!1,error:"Element not found in this frame"}),!0}case"execute_navigate":return window.self===window.top&&(console.log(`ðŸš€ [content] Executing NAVIGATE type: ${e.type}`),e.type==="back"?window.history.length>1?(window.history.back(),n({success:!0})):n({success:!1,error:"Cannot go back"}):e.type==="forward"?(window.history.forward(),n({success:!0})):e.type==="refresh"?(window.location.reload(),n({success:!0})):e.url?(window.location.href=e.url,n({success:!0})):n({success:!1,error:"No navigation type or URL provided"})),!0;case"execute_scroll":{if(console.log(`ðŸ”„ [content] Executing SCROLL direction: ${e.direction}, target: ${e.target}`),e.target){const o=document.querySelector(`[data-crawler-id="${e.target}"]`);o?(o.scrollIntoView({behavior:"smooth",block:"center"}),n({success:!0})):n({success:!1,error:"Target element not found"})}else{const r=window.scrollY,s=(e.direction||"down")==="up"?r-300:r+300;window.scrollTo({top:Math.max(0,s),behavior:"smooth"}),n({success:!0})}return!0}}}catch(o){return console.error("âŒ Message listener error:",o),n({success:!1,error:o.message}),!0}});if(window.self===window.top){console.log("âœ… [content] Running in top-level frame. Initializing crawler and other listeners.");let e=!1;const t=async(o,r=3)=>{for(let i=0;i<r;i++)try{return await chrome.runtime.sendMessage(o),!0}catch(s){if(s.message.includes("Extension context invalidated")||s.message.includes("Receiving end does not exist")){if(i<r-1){const a=100*Math.pow(2,i);await new Promise(l=>setTimeout(l,a))}}else return console.error("âŒ Unexpected runtime error:",s),!1}return!1},n=async()=>{e&&T(),e=!1;const o=await $.analyze();await t({action:"crawlComplete",data:{analysisResult:o,viewport:{width:window.innerWidth,height:window.innerHeight}}})&&(ae($,async i=>{await t({action:"addNewItems",data:i})}),e=!0)};chrome.runtime.onMessage.addListener(o=>{try{switch(o.action){case"runCrawler":n();break;case"FETCH_MAIN_CONTENT":const r=["#post-area",".se-main-container","#postViewArea","div.se_component_wrap","article.se_component_wrap","div.se-viewer","div.blog_content","div.post-view","div.post_content"];let i=null;for(const s of r)if(i=document.querySelector(s),i)break;i?chrome.runtime.sendMessage({action:"PROCESS_HTML_TO_MARKDOWN",html:i.innerHTML,title:document.title}):chrome.runtime.sendMessage({action:"MARKDOWN_RESULT",markdown:"ì˜¤ë¥˜: ë„¤ì´ë²„ ë¸”ë¡œê·¸ ë³¸ë¬¸ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",title:"ì¶”ì¶œ ì˜¤ë¥˜"});break;case"activeElementChanged":if(o.ownerId){const s=document.querySelector(`[data-crawler-id="${o.ownerId}"]`);s&&me(s)}else x();break}}catch(r){console.error("âŒ Top-level message listener error:",r)}}),window.addEventListener("beforeunload",()=>{e&&T()}),n()}else console.log("ðŸš« [content] Running in iframe. Only execution listeners are active.");
