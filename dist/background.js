var j=Object.defineProperty;var X=(e,t,r)=>t in e?j(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var v=(e,t,r)=>X(e,typeof t!="symbol"?t+"":t,r);import{g as m,A as Y}from"./assets/ai-controller.js";class Q{constructor(){v(this,"states",new Map)}updateUrl(t,r){const n=this.getOrCreate(t);return n.lastUrl===r?!1:(n.lastUrl=r,!0)}setDebounce(t,r,n){const a=this.getOrCreate(t);a.debounceTimeout&&clearTimeout(a.debounceTimeout),a.debounceTimeout=setTimeout(r,n)}setActiveElement(t,r){const n=this.getOrCreate(t);n.activeElement={ownerId:r,timestamp:Date.now()}}getActiveElement(t){var r;return(r=this.states.get(t))==null?void 0:r.activeElement}setCrawledData(t,r){const n=this.getOrCreate(t);n.crawledItems=r}appendCrawledData(t,r){const n=this.getOrCreate(t);n.crawledItems||(n.crawledItems=[]),n.crawledItems.push(...r)}getCrawledData(t){var r;return(r=this.states.get(t))==null?void 0:r.crawledItems}setViewport(t,r){const n=this.getOrCreate(t);n.viewport=r}getViewport(t){var r;return(r=this.states.get(t))==null?void 0:r.viewport}setMode(t,r){const n=this.getOrCreate(t);n.mode=r,console.log(`[TabStateManager] Mode for tab ${t} set to: ${r}`)}getMode(t){var r;return(r=this.states.get(t))==null?void 0:r.mode}getTabState(t){return this.states.get(t)}cleanup(t){const r=this.states.get(t);r&&(r.debounceTimeout&&clearTimeout(r.debounceTimeout),r.crawledItems=void 0,r.viewport=void 0,r.mode=void 0),this.states.delete(t),console.log(`[TabStateManager] Cleaned up state for tab ${t}`)}getTabCount(){return this.states.size}getOrCreate(t){return this.states.has(t)||this.states.set(t,{crawledItems:[],viewport:{width:0,height:0},mode:"navigate"}),this.states.get(t)}}const f=new Q;class J{constructor(){v(this,"ready",!1);v(this,"initPromise",null)}async ensureReady(){if(!this.ready){if(this.initPromise)return this.initPromise;this.initPromise=this.createOffscreenDocument(),await this.initPromise}}isReady(){return this.ready}onReady(){this.ready=!0,this.initPromise=null}async createOffscreenDocument(){var t,r;if(!chrome.offscreen)throw new Error("‚ùå Offscreen API not supported");try{if(await((r=(t=chrome.offscreen).hasDocument)==null?void 0:r.call(t))){console.log("üìÑ [offscreen] Document already exists"),this.ready=!0;return}}catch{console.log("‚ö†Ô∏è [offscreen] hasDocument check failed, proceeding...")}try{console.log("üî® [offscreen] Creating document..."),await chrome.offscreen.createDocument({url:"offscreen.html",reasons:[chrome.offscreen.Reason.WORKERS],justification:"AI inference using MediaPipe requires DOM context"}),console.log("‚úÖ [offscreen] Document created successfully")}catch(n){throw console.error("‚ùå [offscreen] Failed to create document:",n.message),n}}}const M=new J;let Z=0;async function y(e){console.log(`üîÑ [ai-handler] Processing AI request: ${e.action}`),console.log("üîç [ai-handler] Full request:",e),console.log(`üìç [ai-handler] Request source: ${e.source||"unknown"}, timestamp: ${e.timestamp||"none"}`);try{M.isReady()||(await M.ensureReady(),await new Promise(s=>{const i=l=>{l.action==="offscreenReady"&&(chrome.runtime.onMessage.removeListener(i),s())};chrome.runtime.onMessage.addListener(i)})),await M.ensureReady();const t=q(e.action),r=`${Date.now()}_${++Z}`,n={action:t,requestId:r,token:e.token,command:e.command,failedTests:e.failedTests,snapshotId:e.snapshotId,description:e.description,crawledItems:e.crawledItems,mode:e.mode};console.log("üì§ [ai-handler] Sending to Offscreen:",n),chrome.runtime.sendMessage(n);const a=ee(e.action);return await new Promise(s=>{let i;const l=u=>{if(u.action===a&&u.requestId===r){if(chrome.runtime.onMessage.removeListener(l),clearTimeout(i),e.action==="loadAIModel"&&u.status)try{chrome.runtime.sendMessage({action:"modelStatusResponse",status:u.status}).catch(()=>{})}catch(w){console.warn("‚ö†Ô∏è [ai-handler] Failed to send model status after load:",w)}s(u)}};chrome.runtime.onMessage.addListener(l);const c=e.action==="downloadAIModel"?12*60*1e3:e.action==="getAIPlan"?3e4:2e4;i=setTimeout(()=>{chrome.runtime.onMessage.removeListener(l),s({error:"AI operation timeout"})},c)})}catch(t){return{error:t.message}}}function q(e){return{getAIPlan:"analyzeIntent",downloadAIModel:"downloadModel",initializeAI:"initializeAI",loadAIModel:"initializeAI",getAIModelStatus:"getModelStatus",testAIAnalysis:"analyzeIntent",deleteAIModel:"deleteModel",switchAIModel:"switchModel",getAvailableModels:"getAvailableModels",getAllModelsStatus:"getAllModelsStatus",getDownloadProgress:"getDownloadProgress",cancelDownload:"cancelDownload"}[e]||e}function ee(e){return{getAIPlan:"analysisResult",downloadAIModel:"modelLoaded",deleteAIModel:"modelDeleted",initializeAI:"aiInitialized",loadAIModel:"aiInitialized",testAIAnalysis:"analysisResult",getAIModelStatus:"modelStatusResponse",switchAIModel:"modelSwitched",getAvailableModels:"availableModelsResponse",getAllModelsStatus:"allModelsStatusResponse",getDownloadProgress:"downloadProgressResponse",cancelDownload:"downloadCancelled"}[e]||"modelStatusResponse"}async function te(){try{const e=m();return{success:!0,models:e.getAvailableModels(),currentModelId:e.getCurrentModelId()}}catch(e){return console.error("‚ùå [ai-handler] Failed to get available models:",e),{success:!1,error:e.message}}}async function re(){try{return{success:!0,states:await m().getAllModelsStatus()}}catch(e){return console.error("‚ùå [ai-handler] Failed to get all models status:",e),{success:!1,error:e.message}}}async function ne(){try{return{success:!0,progress:m().getDownloadProgress()}}catch(e){return console.error("‚ùå [ai-handler] Failed to get download progress:",e),{success:!1,error:e.message}}}async function ae(e,t){var r;try{if(console.log(`üîÑ [ai-handler] Switching to model: ${e}`),await m().switchModel(e,t)){try{chrome.runtime.sendMessage({action:"modelSwitched",modelId:e,modelName:((r=Y[e])==null?void 0:r.name)||e}).catch(()=>{}),chrome.runtime.sendMessage({action:"modelStatusResponse",status:{state:4,error:void 0,currentModelId:e}}).catch(()=>{}),chrome.runtime.sendMessage({action:"modelSwitched",modelId:e}).catch(()=>{})}catch(o){console.warn("‚ö†Ô∏è [ai-handler] Failed to notify model switch:",o)}return{success:!0,modelId:e,message:"Model switched successfully"}}else return{success:!1,error:"Model switch failed"}}catch(n){return console.error(`‚ùå [ai-handler] Failed to switch to model ${e}:`,n),{success:!1,error:n.message}}}async function oe(e,t){try{console.log(`üì• [ai-handler] Starting download for model: ${e||"default"}`);const r=e?m(e):m();let n;return e&&r.getCurrentModelId()!==e?n=await r.switchModel(e,t):n=await r.downloadAndCacheModel(t||"",e),{success:n,modelId:r.getCurrentModelId(),message:n?"Download started successfully":"Download failed to start"}}catch(r){return console.error(`‚ùå [ai-handler] Failed to start download for model ${e}:`,r),{success:!1,error:r.message}}}async function se(e){try{console.log(`üóëÔ∏è [ai-handler] Deleting model: ${e||"current"}`);const t=m();return await t.deleteCachedModel(e),{success:!0,modelId:e||t.getCurrentModelId(),message:"Model deleted successfully"}}catch(t){return console.error(`‚ùå [ai-handler] Failed to delete model ${e}:`,t),{success:!1,error:t.message}}}async function le(){try{return console.log("üö´ [ai-handler] Cancelling download..."),m().cancelDownload(),{success:!0,message:"Download cancelled successfully"}}catch(e){return console.error("‚ùå [ai-handler] Failed to cancel download:",e),{success:!1,error:e.message}}}async function L(e,t){var o;const{action:r,ownerId:n,tabId:a}=e;console.log(`üéØ [highlight-handler] Processing ${r}, ownerId: ${n}`);try{const s=a||((o=t.tab)==null?void 0:o.id);return s?(f.setActiveElement(s,n),await ie(s,n),await ce(s,n),console.log(`‚úÖ [highlight-handler] Active element set for tab ${s}: ${n}`),!0):(console.warn("‚ùå [highlight-handler] No tab ID available"),!1)}catch(s){return console.error("‚ùå [highlight-handler] Error:",s.message),!1}}async function ie(e,t){try{await chrome.tabs.sendMessage(e,{action:"activeElementChanged",ownerId:t})}catch{console.log(`[highlight-handler] Content script not ready for tab ${e}`)}}async function ce(e,t){try{chrome.runtime.sendMessage({action:"activeElementChanged",tabId:e,ownerId:t})}catch{console.log("[highlight-handler] Panel not open for notification")}}async function de(e,t){var o,s;const{analysisResult:r,viewport:n}=e.data,a=(o=t.tab)==null?void 0:o.id;if(!a)return console.warn("‚ùå [crawl-handler] No tab ID for crawl complete"),!1;console.log(`üìä [crawl-handler] Crawl completed for tab ${a}:`,(s=r.items)==null?void 0:s.length,"items"),r.items&&f.setCrawledData(a,r.items),n&&f.setViewport(a,n);try{return chrome.runtime.sendMessage({action:"updatePanelData",tabId:a,data:r}),console.log("‚úÖ [crawl-handler] Crawl result forwarded to panel"),!0}catch{return console.log("[crawl-handler] Panel not open, crawl result stored in TabStateManager"),!0}}async function ue(e,t){var a;const{data:r}=e,n=(a=t.tab)==null?void 0:a.id;if(!n||!r||r.length===0)return console.warn("‚ùå [crawl-handler] No tab ID or new items to add"),!1;console.log(`‚ûï [crawl-handler] Adding ${r.length} new items for tab ${n}`),f.appendCrawledData(n,r);try{return chrome.runtime.sendMessage({action:"addNewItems",tabId:n,data:r}),console.log("‚úÖ [crawl-handler] New items forwarded to panel"),!0}catch{return console.log("[crawl-handler] Panel not open, new items stored in TabStateManager"),!0}}function fe(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)r.hasOwnProperty(n)&&(e[n]=r[n])}return e}function $(e,t){return Array(t+1).join(e)}function he(e){return e.replace(/^\n*/,"")}function ge(e){for(var t=e.length;t>0&&e[t-1]===`
`;)t--;return e.substring(0,t)}var me=["ADDRESS","ARTICLE","ASIDE","AUDIO","BLOCKQUOTE","BODY","CANVAS","CENTER","DD","DIR","DIV","DL","DT","FIELDSET","FIGCAPTION","FIGURE","FOOTER","FORM","FRAMESET","H1","H2","H3","H4","H5","H6","HEADER","HGROUP","HR","HTML","ISINDEX","LI","MAIN","MENU","NAV","NOFRAMES","NOSCRIPT","OL","OUTPUT","P","PRE","SECTION","TABLE","TBODY","TD","TFOOT","TH","THEAD","TR","UL"];function D(e){return O(e,me)}var _=["AREA","BASE","BR","COL","COMMAND","EMBED","HR","IMG","INPUT","KEYGEN","LINK","META","PARAM","SOURCE","TRACK","WBR"];function x(e){return O(e,_)}function pe(e){return F(e,_)}var B=["A","TABLE","THEAD","TBODY","TFOOT","TH","TD","IFRAME","SCRIPT","AUDIO","VIDEO"];function we(e){return O(e,B)}function ve(e){return F(e,B)}function O(e,t){return t.indexOf(e.nodeName)>=0}function F(e,t){return e.getElementsByTagName&&t.some(function(r){return e.getElementsByTagName(r).length})}var d={};d.paragraph={filter:"p",replacement:function(e){return`

`+e+`

`}};d.lineBreak={filter:"br",replacement:function(e,t,r){return r.br+`
`}};d.heading={filter:["h1","h2","h3","h4","h5","h6"],replacement:function(e,t,r){var n=Number(t.nodeName.charAt(1));if(r.headingStyle==="setext"&&n<3){var a=$(n===1?"=":"-",e.length);return`

`+e+`
`+a+`

`}else return`

`+$("#",n)+" "+e+`

`}};d.blockquote={filter:"blockquote",replacement:function(e){return e=e.replace(/^\n+|\n+$/g,""),e=e.replace(/^/gm,"> "),`

`+e+`

`}};d.list={filter:["ul","ol"],replacement:function(e,t){var r=t.parentNode;return r.nodeName==="LI"&&r.lastElementChild===t?`
`+e:`

`+e+`

`}};d.listItem={filter:"li",replacement:function(e,t,r){var n=r.bulletListMarker+"   ",a=t.parentNode;if(a.nodeName==="OL"){var o=a.getAttribute("start"),s=Array.prototype.indexOf.call(a.children,t);n=(o?Number(o)+s:s+1)+".  "}return e=e.replace(/^\n+/,"").replace(/\n+$/,`
`).replace(/\n/gm,`
`+" ".repeat(n.length)),n+e+(t.nextSibling&&!/\n$/.test(e)?`
`:"")}};d.indentedCodeBlock={filter:function(e,t){return t.codeBlockStyle==="indented"&&e.nodeName==="PRE"&&e.firstChild&&e.firstChild.nodeName==="CODE"},replacement:function(e,t,r){return`

    `+t.firstChild.textContent.replace(/\n/g,`
    `)+`

`}};d.fencedCodeBlock={filter:function(e,t){return t.codeBlockStyle==="fenced"&&e.nodeName==="PRE"&&e.firstChild&&e.firstChild.nodeName==="CODE"},replacement:function(e,t,r){for(var n=t.firstChild.getAttribute("class")||"",a=(n.match(/language-(\S+)/)||[null,""])[1],o=t.firstChild.textContent,s=r.fence.charAt(0),i=3,l=new RegExp("^"+s+"{3,}","gm"),c;c=l.exec(o);)c[0].length>=i&&(i=c[0].length+1);var u=$(s,i);return`

`+u+a+`
`+o.replace(/\n$/,"")+`
`+u+`

`}};d.horizontalRule={filter:"hr",replacement:function(e,t,r){return`

`+r.hr+`

`}};d.inlineLink={filter:function(e,t){return t.linkStyle==="inlined"&&e.nodeName==="A"&&e.getAttribute("href")},replacement:function(e,t){var r=t.getAttribute("href");r&&(r=r.replace(/([()])/g,"\\$1"));var n=C(t.getAttribute("title"));return n&&(n=' "'+n.replace(/"/g,'\\"')+'"'),"["+e+"]("+r+n+")"}};d.referenceLink={filter:function(e,t){return t.linkStyle==="referenced"&&e.nodeName==="A"&&e.getAttribute("href")},replacement:function(e,t,r){var n=t.getAttribute("href"),a=C(t.getAttribute("title"));a&&(a=' "'+a+'"');var o,s;switch(r.linkReferenceStyle){case"collapsed":o="["+e+"][]",s="["+e+"]: "+n+a;break;case"shortcut":o="["+e+"]",s="["+e+"]: "+n+a;break;default:var i=this.references.length+1;o="["+e+"]["+i+"]",s="["+i+"]: "+n+a}return this.references.push(s),o},references:[],append:function(e){var t="";return this.references.length&&(t=`

`+this.references.join(`
`)+`

`,this.references=[]),t}};d.emphasis={filter:["em","i"],replacement:function(e,t,r){return e.trim()?r.emDelimiter+e+r.emDelimiter:""}};d.strong={filter:["strong","b"],replacement:function(e,t,r){return e.trim()?r.strongDelimiter+e+r.strongDelimiter:""}};d.code={filter:function(e){var t=e.previousSibling||e.nextSibling,r=e.parentNode.nodeName==="PRE"&&!t;return e.nodeName==="CODE"&&!r},replacement:function(e){if(!e)return"";e=e.replace(/\r?\n|\r/g," ");for(var t=/^`|^ .*?[^ ].* $|`$/.test(e)?" ":"",r="`",n=e.match(/`+/gm)||[];n.indexOf(r)!==-1;)r=r+"`";return r+t+e+t+r}};d.image={filter:"img",replacement:function(e,t){var r=C(t.getAttribute("alt")),n=t.getAttribute("src")||"",a=C(t.getAttribute("title")),o=a?' "'+a+'"':"";return n?"!["+r+"]("+n+o+")":""}};function C(e){return e?e.replace(/(\n+\s*)+/g,`
`):""}function H(e){this.options=e,this._keep=[],this._remove=[],this.blankRule={replacement:e.blankReplacement},this.keepReplacement=e.keepReplacement,this.defaultRule={replacement:e.defaultReplacement},this.array=[];for(var t in e.rules)this.array.push(e.rules[t])}H.prototype={add:function(e,t){this.array.unshift(t)},keep:function(e){this._keep.unshift({filter:e,replacement:this.keepReplacement})},remove:function(e){this._remove.unshift({filter:e,replacement:function(){return""}})},forNode:function(e){if(e.isBlank)return this.blankRule;var t;return(t=k(this.array,e,this.options))||(t=k(this._keep,e,this.options))||(t=k(this._remove,e,this.options))?t:this.defaultRule},forEach:function(e){for(var t=0;t<this.array.length;t++)e(this.array[t],t)}};function k(e,t,r){for(var n=0;n<e.length;n++){var a=e[n];if(ye(a,t,r))return a}}function ye(e,t,r){var n=e.filter;if(typeof n=="string"){if(n===t.nodeName.toLowerCase())return!0}else if(Array.isArray(n)){if(n.indexOf(t.nodeName.toLowerCase())>-1)return!0}else if(typeof n=="function"){if(n.call(e,t,r))return!0}else throw new TypeError("`filter` needs to be a string, array, or function")}function Ae(e){var t=e.element,r=e.isBlock,n=e.isVoid,a=e.isPre||function(w){return w.nodeName==="PRE"};if(!(!t.firstChild||a(t))){for(var o=null,s=!1,i=null,l=P(i,t,a);l!==t;){if(l.nodeType===3||l.nodeType===4){var c=l.data.replace(/[ \r\n\t]+/g," ");if((!o||/ $/.test(o.data))&&!s&&c[0]===" "&&(c=c.substr(1)),!c){l=N(l);continue}l.data=c,o=l}else if(l.nodeType===1)r(l)||l.nodeName==="BR"?(o&&(o.data=o.data.replace(/ $/,"")),o=null,s=!1):n(l)||a(l)?(o=null,s=!0):o&&(s=!1);else{l=N(l);continue}var u=P(i,l,a);i=l,l=u}o&&(o.data=o.data.replace(/ $/,""),o.data||N(o))}}function N(e){var t=e.nextSibling||e.parentNode;return e.parentNode.removeChild(e),t}function P(e,t,r){return e&&e.parentNode===t||r(t)?t.nextSibling||t.parentNode:t.firstChild||t.nextSibling||t.parentNode}var S=typeof window<"u"?window:{};function Me(){var e=S.DOMParser,t=!1;try{new e().parseFromString("","text/html")&&(t=!0)}catch{}return t}function Ce(){var e=function(){};return be()?e.prototype.parseFromString=function(t){var r=new window.ActiveXObject("htmlfile");return r.designMode="on",r.open(),r.write(t),r.close(),r}:e.prototype.parseFromString=function(t){var r=document.implementation.createHTMLDocument("");return r.open(),r.write(t),r.close(),r},e}function be(){var e=!1;try{document.implementation.createHTMLDocument("").open()}catch{S.ActiveXObject&&(e=!0)}return e}var Re=Me()?S.DOMParser:Ce();function Te(e,t){var r;if(typeof e=="string"){var n=ke().parseFromString('<x-turndown id="turndown-root">'+e+"</x-turndown>","text/html");r=n.getElementById("turndown-root")}else r=e.cloneNode(!0);return Ae({element:r,isBlock:D,isVoid:x,isPre:t.preformattedCode?Ne:null}),r}var E;function ke(){return E=E||new Re,E}function Ne(e){return e.nodeName==="PRE"||e.nodeName==="CODE"}function Ee(e,t){return e.isBlock=D(e),e.isCode=e.nodeName==="CODE"||e.parentNode.isCode,e.isBlank=$e(e),e.flankingWhitespace=De(e,t),e}function $e(e){return!x(e)&&!we(e)&&/^\s*$/i.test(e.textContent)&&!pe(e)&&!ve(e)}function De(e,t){if(e.isBlock||t.preformattedCode&&e.isCode)return{leading:"",trailing:""};var r=Oe(e.textContent);return r.leadingAscii&&U("left",e,t)&&(r.leading=r.leadingNonAscii),r.trailingAscii&&U("right",e,t)&&(r.trailing=r.trailingNonAscii),{leading:r.leading,trailing:r.trailing}}function Oe(e){var t=e.match(/^(([ \t\r\n]*)(\s*))(?:(?=\S)[\s\S]*\S)?((\s*?)([ \t\r\n]*))$/);return{leading:t[1],leadingAscii:t[2],leadingNonAscii:t[3],trailing:t[4],trailingNonAscii:t[5],trailingAscii:t[6]}}function U(e,t,r){var n,a,o;return e==="left"?(n=t.previousSibling,a=/ $/):(n=t.nextSibling,a=/^ /),n&&(n.nodeType===3?o=a.test(n.nodeValue):r.preformattedCode&&n.nodeName==="CODE"?o=!1:n.nodeType===1&&!D(n)&&(o=a.test(n.textContent))),o}var Se=Array.prototype.reduce,Ie=[[/\\/g,"\\\\"],[/\*/g,"\\*"],[/^-/g,"\\-"],[/^\+ /g,"\\+ "],[/^(=+)/g,"\\$1"],[/^(#{1,6}) /g,"\\$1 "],[/`/g,"\\`"],[/^~~~/g,"\\~~~"],[/\[/g,"\\["],[/\]/g,"\\]"],[/^>/g,"\\>"],[/_/g,"\\_"],[/^(\d+)\. /g,"$1\\. "]];function b(e){if(!(this instanceof b))return new b(e);var t={rules:d,headingStyle:"setext",hr:"* * *",bulletListMarker:"*",codeBlockStyle:"indented",fence:"```",emDelimiter:"_",strongDelimiter:"**",linkStyle:"inlined",linkReferenceStyle:"full",br:"  ",preformattedCode:!1,blankReplacement:function(r,n){return n.isBlock?`

`:""},keepReplacement:function(r,n){return n.isBlock?`

`+n.outerHTML+`

`:n.outerHTML},defaultReplacement:function(r,n){return n.isBlock?`

`+r+`

`:r}};this.options=fe({},t,e),this.rules=new H(this.options)}b.prototype={turndown:function(e){if(!Ue(e))throw new TypeError(e+" is not a string, or an element/document/fragment node.");if(e==="")return"";var t=W.call(this,new Te(e,this.options));return Le.call(this,t)},use:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)this.use(e[t]);else if(typeof e=="function")e(this);else throw new TypeError("plugin must be a Function or an Array of Functions");return this},addRule:function(e,t){return this.rules.add(e,t),this},keep:function(e){return this.rules.keep(e),this},remove:function(e){return this.rules.remove(e),this},escape:function(e){return Ie.reduce(function(t,r){return t.replace(r[0],r[1])},e)}};function W(e){var t=this;return Se.call(e.childNodes,function(r,n){n=new Ee(n,t.options);var a="";return n.nodeType===3?a=n.isCode?n.nodeValue:t.escape(n.nodeValue):n.nodeType===1&&(a=Pe.call(t,n)),V(r,a)},"")}function Le(e){var t=this;return this.rules.forEach(function(r){typeof r.append=="function"&&(e=V(e,r.append(t.options)))}),e.replace(/^[\t\r\n]+/,"").replace(/[\t\r\n\s]+$/,"")}function Pe(e){var t=this.rules.forNode(e),r=W.call(this,e),n=e.flankingWhitespace;return(n.leading||n.trailing)&&(r=r.trim()),n.leading+t.replacement(r,e,this.options)+n.trailing}function V(e,t){var r=ge(e),n=he(t),a=Math.max(e.length-r.length,t.length-n.length),o=`

`.substring(0,a);return r+o+n}function Ue(e){return e!=null&&(typeof e=="string"||e.nodeType&&(e.nodeType===1||e.nodeType===9||e.nodeType===11))}async function _e(e,t){switch(e.action){case"GET_PAGE_CONTENT":return await xe();case"PROCESS_HTML_TO_MARKDOWN":return await Be(e);case"DOWNLOAD_MARKDOWN":return await Fe(e);default:return console.warn(`Unknown markdown action: ${e.action}`),{error:`Unknown markdown action: ${e.action}`}}}async function xe(){try{const e=await chrome.tabs.query({active:!0,currentWindow:!0});e.length>0&&e[0].id?await chrome.tabs.sendMessage(e[0].id,{action:"FETCH_MAIN_CONTENT"}):(console.error("Markdown Handler: No active tab found."),await chrome.runtime.sendMessage({action:"MARKDOWN_RESULT",markdown:"Ïò§Î•ò: ÌôúÏÑ± ÌÉ≠ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†ÄÏùò ÌòÑÏû¨ ÌÉ≠ÏóêÏÑú Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.",title:"Ïò§Î•ò"}))}catch(e){console.error("Error in handleGetPageContent:",e),await chrome.runtime.sendMessage({action:"MARKDOWN_RESULT",markdown:`Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${e.message}`,title:"Ïò§Î•ò"})}}async function Be(e){try{const r=new b({headingStyle:"atx"}).turndown(e.html);await chrome.runtime.sendMessage({action:"MARKDOWN_RESULT",markdown:r,title:e.title})}catch(t){console.error("Error converting HTML to Markdown:",t),await chrome.runtime.sendMessage({action:"MARKDOWN_RESULT",markdown:`ÎßàÌÅ¨Îã§Ïö¥ Î≥ÄÌôò Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${t.message}`,title:"Î≥ÄÌôò Ïò§Î•ò"})}}async function Fe(e){try{const{markdown:t,title:r}=e,a=`${r.replace(/[\\/\:\"*?<>|]/g,"_").replace(/\s+/g," ").trim()||"Untitled"}.md`,o=new Blob([t],{type:"text/markdown;charset=utf-8"}),s=URL.createObjectURL(o);await chrome.downloads.download({url:s,filename:a,saveAs:!0})}catch(t){console.error("Error during download:",t)}}function He(e,t){const r=e.top+e.height,n=e.left+e.width;return e.top>=0&&e.left>=0&&r<=t.height&&n<=t.width&&e.width>0&&e.height>0}function We(e,t){const r=t.split(/\s+/).filter(a=>a.length>1);return r.length===0?e:e.map(a=>{let o=0;const s=`${a.text||""} ${a.label||""} ${a.placeholder||""}`.toLowerCase(),i=a.type.toLowerCase();for(const l of r){const c=l.toLowerCase();s.includes(c)&&(o+=5),i.includes(c)&&(o+=10)}return{item:a,score:o}}).filter(a=>a.score>0).sort((a,o)=>o.score-a.score).map(a=>a.item)}async function Ve(e,t){var s,i;const{command:r}=e,n=((s=t.tab)==null?void 0:s.id)||e.tabId,a=40;if(!n)return console.error("‚ùå [Orchestrator] No tab ID found for the command."),{success:!1,error:"No tab ID"};const o=r.toLowerCase();if(o.includes("ÌÉêÏÉâ Î™®Îìú"))return f.setMode(n,"navigate"),{success:!0,message:"Mode changed to navigate."};if(o.includes("Í≤ÄÏÉâ Î™®Îìú"))return f.setMode(n,"search"),{success:!0,message:"Mode changed to search."};console.log(`ü§ñ [Orchestrator] Processing command for tab ${n}: "${r}"`);try{const l=f.getCrawledData(n),c=f.getViewport(n),u=f.getMode(n)||"navigate";if(!l||l.length===0||!c)return console.warn(`‚ö†Ô∏è [Orchestrator] No crawled data or viewport info for tab ${n}.`),{success:!1,error:"No crawled data or viewport info for this tab."};const w=l.filter(h=>He(h.rect,c)),G=We(w,r),R=[...new Set([...G,...w])].slice(0,a);console.log(`[Orchestrator] Filtered to ${R.length} items for AI in ${u} mode.`),R.forEach(h=>{h.id>=10&&h.id<=15&&console.log(`üîç [DEBUG] Item ${h.id}: type=${h.type}, text="${h.text}", isClickable=${h.isClickable}, isInputtable=${h.isInputtable}`)});const T=await y({action:"getAIPlan",command:r,crawledItems:R,mode:u});if(T.error)throw new Error(T.error);const p=T.result;if(console.log("üß† [Orchestrator] AI analysis result:",p),!p.plan||p.plan.length===0)return console.log("ü§î [Orchestrator] AI returned an empty plan."),{success:!0,steps:0,message:"AI could not determine an action."};for(const[h,g]of p.plan.entries()){switch(console.log(`üîÑ [Orchestrator] Executing step ${h+1}/${p.plan.length} on tab ${n}:`,g),g.action){case"CLICK":await A(n,{action:"execute_click",crawlerId:g.id});break;case"INPUT":await A(n,{action:"execute_input",crawlerId:g.id,value:g.value});break;case"NAVIGATE":await A(n,{action:"execute_navigate",type:g.type});break;case"SCROLL":await A(n,{action:"execute_scroll",direction:g.direction,target:g.target});break;default:console.warn("‚ö†Ô∏è [Orchestrator] Unknown action in AI plan:",g)}g.action==="INPUT"&&((i=p.plan[h+1])==null?void 0:i.action)==="CLICK"&&(console.log("[Orchestrator] INPUT followed by CLICK, adding 300ms delay."),await new Promise(z=>setTimeout(z,300)))}return console.log(`‚úÖ [Orchestrator] Command sequence completed for "${r}"`),{success:!0,steps:p.plan.length}}catch(l){return console.error("‚ùå [Orchestrator] Error processing command:",l),{success:!1,error:l instanceof Error?l.message:"Unknown error"}}}async function A(e,t){try{const r=await chrome.tabs.sendMessage(e,t);return(r==null?void 0:r.success)===!1&&console.error("[Orchestrator] Step failed in content script:",r.error),r}catch(r){console.error(`‚ùå [Orchestrator] Failed to send message to content script on tab ${e}:`,r)}}class Ke{constructor(){v(this,"handlers",new Map);this.initializeHandlers()}initializeHandlers(){["getAIModelStatus","initializeAI","loadAIModel"].forEach(n=>{this.handlers.set(n,y)}),this.handlers.set("getAvailableModels",()=>te()),this.handlers.set("getAllModelsStatus",()=>re()),this.handlers.set("getDownloadProgress",()=>ne()),this.handlers.set("switchAIModel",n=>ae(n.modelId,n.token)),this.handlers.set("cancelDownload",()=>le()),this.handlers.set("downloadAIModel",n=>n.modelId?oe(n.modelId,n.token):y(n)),this.handlers.set("deleteAIModel",n=>n.modelId?se(n.modelId):y(n)),this.handlers.set("executeVoiceCommand",Ve),this.handlers.set("sendChatMessage",this.handleChatMessage.bind(this)),this.handlers.set("highlightElement",L),this.handlers.set("setActiveElement",L),this.handlers.set("crawlComplete",de),this.handlers.set("addNewItems",ue),["GET_PAGE_CONTENT","PROCESS_HTML_TO_MARKDOWN","DOWNLOAD_MARKDOWN"].forEach(n=>{this.handlers.set(n,_e)})}async route(t,r){const n=this.handlers.get(t.action);return n?await n(t,r):t.action.endsWith("Response")||t.action.endsWith("response")?{ignored:!0,reason:"Response message - handled by target component"}:(console.warn(`‚ö†Ô∏è [router] No handler for action: ${t.action}`),{error:`Unknown action: ${t.action}`})}registerHandler(t,r){this.handlers.set(t,r),console.log(`‚ûï [router] Handler registered for action: ${t}`)}unregisterHandler(t){const r=this.handlers.delete(t);return r&&console.log(`‚ûñ [router] Handler unregistered for action: ${t}`),r}async handleChatMessage(t,r){var n,a;try{console.log("üí¨ [router] Processing chat message:",t.message);const o=await y({action:"getAIPlan",command:t.message,crawledItems:[],mode:"chat"});if(o.error)return console.error("‚ùå [router] Chat message handling failed:",o.error),{success:!1,error:o.error};const s=((n=o.result)==null?void 0:n.rawResponse)||((a=o.result)==null?void 0:a.reasoning)||"ÏùëÎãµÏùÑ ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.";return console.log("‚úÖ [router] Chat response generated:",s),{success:!0,reply:s}}catch(o){return console.error("‚ùå [router] Chat message handling failed:",o),{success:!1,error:o.message||"Ï±ÑÌåÖ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."}}}getRegisteredActions(){return Array.from(this.handlers.keys())}}const Ge=new Ke;function K(e,t){if(console.log(`üîç [url-handler] Processing URL change for tab ${e}: ${t}`),!I(t)){console.log(`üö´ [url-handler] Invalid URL rejected for tab ${e}: ${t}`);return}const r=f.getTabState(e);if(console.log(`üìã [url-handler] Previous URL for tab ${e}:`,r==null?void 0:r.lastUrl),!f.updateUrl(e,t)){console.log(`üîÑ [url-handler] Duplicate URL ignored for tab ${e}: ${t}`);return}console.log(`‚úÖ [url-handler] New URL confirmed for tab ${e}: ${t}`),console.log(`‚è±Ô∏è  [url-handler] Setting 300ms debounce timer for tab ${e}`),f.setDebounce(e,()=>{console.log(`üöÄ [url-handler] Debounce timer fired for tab ${e} - triggering crawler`),ze(e,t)},300)}async function ze(e,t){try{console.log(`üï∑Ô∏è [url-handler] Triggering crawler for tab ${e} at URL: ${t}`);const r=await je(e);if(!r){console.log(`‚ùå [url-handler] Tab ${e} not found, cannot trigger crawler`);return}console.log(`üìã [url-handler] Tab ${e} status: ${r.status}, URL: ${r.url}`);const n={action:"runCrawler",url:t};console.log(`üì§ [url-handler] Sending message to tab ${e}:`,n),await chrome.tabs.sendMessage(e,n),console.log(`‚úÖ [url-handler] Crawler message sent successfully to tab ${e}`)}catch(r){console.error(`‚ùå [url-handler] Failed to trigger crawler for tab ${e}:`,{error:r.message,url:t,timestamp:new Date().toISOString()}),r.message.includes("Receiving end does not exist")&&console.log(`üîÑ [url-handler] Content Script may not be ready for tab ${e}. Will retry on next URL change.`)}}function I(e){return!(!e||!e.startsWith("http://")&&!e.startsWith("https://")||e.startsWith("chrome://")||e.startsWith("chrome-extension://")||e.startsWith("file://"))}async function je(e){try{return await chrome.tabs.get(e)}catch{return console.log(`[url-handler] Tab ${e} not found or inaccessible`),null}}const Xe={SIDE_PANEL:{OPEN_ON_ACTION_CLICK:!0}};console.log("üöÄ [background] Background script started with 5-folder architecture");chrome.runtime.onMessage.addListener((e,t,r)=>e.action==="offscreenReady"?(M.onReady(),console.log("‚úÖ [background] Offscreen document ready"),!0):["modelStatusResponse","modelLoaded","modelDeleted","aiInitialized","analysisResult"].includes(e.action)?(console.log(`üì¨ [background] Response message received: ${e.action} - forwarding to all tabs and extension`),chrome.runtime.sendMessage(e).catch(()=>{console.log(`üì® [background] No receivers for response: ${e.action}`)}),!1):(Ge.route(e,t).then(a=>{a!==void 0&&r(a)}).catch(a=>{console.error("‚ùå [background] Message routing error:",a),r({error:a.message})}),!0));chrome.tabs.onActivated.addListener(e=>{console.log(`üîÄ [background] Tab activated: ${e.tabId}`),chrome.tabs.get(e.tabId,t=>{if(console.log(`üìã [background] Tab ${e.tabId} info:`,{url:t.url,status:t.status,title:t.title}),t.url){const r=I(t.url);console.log(`üîç [background] URL validation for "${t.url}": ${r}`),r?(console.log("‚úÖ [background] Valid URL detected, handling change"),K(e.tabId,t.url)):console.log("‚ùå [background] Invalid URL, skipping:",t.url)}else console.log(`‚ùå [background] No URL available for tab ${e.tabId}`)})});chrome.tabs.onUpdated.addListener((e,t,r)=>{if(console.log(`üîÑ [background] Tab ${e} updated:`,{url:t.url,status:t.status,title:r.title,currentUrl:r.url}),t.url&&r.url){const n=I(r.url);console.log(`üîç [background] URL validation for updated tab "${r.url}": ${n}`),n?(console.log(`üîó [background] URL changed for tab ${e}: ${t.url} ‚Üí ${r.url}`),K(e,r.url)):console.log(`üö´ [background] Invalid URL update ignored for tab ${e}: ${t.url}`)}else t.url?console.log(`‚ö†Ô∏è [background] URL change detected but validation failed - changeInfo.url: ${t.url}, tab.url: ${r.url}`):console.log(`üìù [background] Non-URL update for tab ${e}: status=${t.status}`)});chrome.tabs.onRemoved.addListener(e=>{f.cleanup(e),console.log(`üóëÔ∏è [background] Cleaned up state for closed tab ${e}`)});chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:Xe.SIDE_PANEL.OPEN_ON_ACTION_CLICK}).catch(console.error);console.log("‚úÖ [background] All event listeners registered successfully");
